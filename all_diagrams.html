<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Moderation Engine - Updated Architecture Diagrams</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.2em;
            margin-bottom: 20px;
        }

        .upgrade-badge {
            background: linear-gradient(45deg, #ff6b6b, #ffa726);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            display: inline-block;
            margin: 10px 5px;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .stat-item {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .diagram-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .diagram-title {
            color: #2c3e50;
            font-size: 1.8em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .diagram-description {
            color: #7f8c8d;
            margin-bottom: 25px;
            font-size: 1.1em;
            line-height: 1.6;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .new-feature {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
            margin-left: 8px;
        }

        .mermaid {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            font-size: 18px;
        }

        .back-to-top:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .stats {
                gap: 15px;
            }
            
            .diagram-container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ›¡ï¸ Content Moderation Engine v3.0</h1>
            <p class="subtitle">Complete 5-Stage Modular Pipeline with LLM Integration</p>
            <div style="margin: 15px 0;">
                <span class="upgrade-badge">ğŸ”§ 5-Stage Pipeline</span>
                <span class="upgrade-badge">ğŸ§  LLM Integration</span>
                <span class="upgrade-badge">ğŸ¯ CiferAI Fraud Detection</span>
                <span class="upgrade-badge">âš ï¸ Error Handling</span>
                <span class="upgrade-badge">ğŸ“Š Comprehensive Analytics</span>
            </div>
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-number">14</span>
                    <span class="stat-label">Complete Diagrams</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">5</span>
                    <span class="stat-label">Pipeline Stages</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">4</span>
                    <span class="stat-label">AI Models</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">2736</span>
                    <span class="stat-label">Keywords</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">100%</span>
                    <span class="stat-label">Coverage</span>
                </div>
            </div>
        </header>

        <!-- Diagram 1: Enhanced System Overview -->
        <div class="diagram-container">
            <h2 class="diagram-title">ğŸŒŸ Enhanced System Flow with Band Classification<span class="new-feature">NEW</span></h2>
            <div class="diagram-description">
                <strong>Complete user journey</strong> with the new FinBERT 5-layer band system (SAFE, FLAG_LOW, FLAG_MEDIUM, FLAG_HIGH, BLOCK) and enhanced action classification. Shows sophisticated risk assessment and visual feedback.
            </div>
            <div class="mermaid">
graph TD
    A["ğŸŒ Frontend<br/>index.html<br/>Enhanced UI"] --> B["ğŸ“¤ User Input<br/>Content Submission"]
    B --> C["ğŸš€ HTTP POST Request<br/>/moderate"]
    C --> D["âš¡ FastAPI Server<br/>main.py:app"]
    
    D --> E["ğŸ›¡ï¸ GuardianModerationEngine v2.0<br/>core/moderation.py"]
    
    E --> F["ğŸ“‹ Stage 1: Rule-Based Filter<br/>Keywords + Regex"]
    F --> G{"ğŸ” Keywords/Patterns Found?"}
    G -->|Yes| H["âŒ BLOCK<br/>Band: BLOCK<br/>Action: BLOCK<br/>Threat: High"]
    G -->|No| I["âœ… Continue to Stage 2"]
    
    I --> J["ğŸ¤– Stage 2: Detoxify AI<br/>Toxicity Detection"]
    J --> K{"ğŸ§  Toxic Content<br/>Score > 0.5?"}
    K -->|Yes| L["âŒ BLOCK<br/>Band: BLOCK<br/>Action: BLOCK<br/>Threat: Medium/High"]
    K -->|No| M["âœ… Continue to Stage 3"]
    
    M --> N["ğŸ’° Stage 3: FinBERT AI<br/>5-Layer Band System"]
    N --> O["ğŸ“Š Confidence Analysis"]
    O --> P{"ğŸ¯ Band Classification"}
    
    P --> Q["ğŸŸ¢ SAFE<br/>0.0-0.2<br/>Action: PASS"]
    P --> R["ğŸŸ¡ FLAG_LOW<br/>0.2-0.4<br/>Action: FLAG_LOW"]
    P --> S["ğŸŸ  FLAG_MEDIUM<br/>0.4-0.6<br/>Action: FLAG_MEDIUM"]
    P --> T["ğŸ”´ FLAG_HIGH<br/>0.6-0.8<br/>Action: FLAG_HIGH"]
    P --> U["ğŸŸ£ BLOCK<br/>0.8-1.0<br/>Action: BLOCK"]
    
    H --> V["ğŸ’¾ Enhanced Database<br/>SQLite + Band/Action"]
    L --> V
    Q --> V
    R --> V
    S --> V
    T --> V
    U --> V
    
    V --> W["ğŸ“Š Enhanced Response<br/>ModerationResponse v2.0"]
    W --> X["ğŸ”„ Updated Frontend<br/>Band Badges + Confidence Bars"]
    
    Y["ğŸ“ data/external/words.json<br/>2736 Keywords"] --> F
    Z["ğŸ—„ï¸ moderation.db<br/>Enhanced Schema"] --> V
    
    style A fill:#e1f5fe
    style D fill:#f3e5f5
    style E fill:#fff3e0
    style N fill:#fff8e1
    style Q fill:#c8e6c9
    style R fill:#fff3cd
    style S fill:#ffe0b3
    style T fill:#ffcdd2
    style U fill:#e1bee7
    style V fill:#f3e5f5
    style X fill:#e8f5e8
            </div>
        </div>

        <!-- Diagram 2: Enhanced Engine Pipeline -->
        <div class="diagram-container">
            <h2 class="diagram-title">ğŸ”§ Advanced Moderation Pipeline with Band Logic<span class="new-feature">ENHANCED</span></h2>
            <div class="diagram-description">
                <strong>Detailed internal processing</strong> showing the new FinBERT band classification system with precise confidence thresholds, action mapping, and sophisticated financial risk assessment.
            </div>
            <div class="mermaid">
graph TD
    A["ğŸ›¡ï¸ GuardianModerationEngine.moderate_content()"] --> B["ğŸ“ Input: Content String"]
    
    B --> C["ğŸ”´ Stage 1: Rule-Based Filter"]
    C --> D["ğŸ“š Load Keywords from<br/>data/external/words.json<br/>(2736 keywords)"]
    D --> E["ğŸ” Whole Word Keyword Matching"]
    E --> F["ğŸ¯ Enhanced Regex Patterns<br/>URLs, Emails, Threats, Violence"]
    F --> G{"â“ Rule Violations?"}
    
    G -->|Yes| H["âŒ Return ModerationResult<br/>accepted=False<br/>stage='rule-based'<br/>threat_level='high'<br/>band='BLOCK'<br/>action='BLOCK'<br/>confidence=1.0"]
    
    G -->|No| I["ğŸŸ¡ Stage 2: Detoxify Check"]
    I --> J["ğŸ¤– Initialize Detoxify Model<br/>unitary/toxic-bert"]
    J --> K["ğŸ§  Toxicity Classification"]
    K --> L["ğŸ“Š Get Toxicity Score (0-1)"]
    L --> M{"ğŸšï¸ Score > threshold<br/>(0.5)?"}
    
    M -->|Yes| N["âŒ Return ModerationResult<br/>accepted=False<br/>stage='detoxify'<br/>threat_level='medium/high'<br/>band='BLOCK'<br/>action='BLOCK'<br/>confidence=score"]
    
    M -->|No| O["ğŸŸ¢ Stage 3: FinBERT Advanced"]
    O --> P["ğŸ’° Initialize FinBERT Model<br/>ProsusAI/finbert"]
    P --> Q["ğŸ“ˆ Financial Sentiment Analysis"]
    Q --> R["ğŸ“Š Get Sentiment + Confidence"]
    R --> S{"ğŸ“‰ Negative Sentiment?"}
    
    S -->|No| T["ğŸŸ¢ Non-Financial Content<br/>band='SAFE'<br/>action='PASS'<br/>threat_level='low'"]
    
    S -->|Yes| U["ğŸ¯ _get_finbert_band() Method"]
    U --> V["ğŸ“Š 5-Layer Band Classification"]
    
    V --> W["ğŸŸ¢ SAFE Band<br/>Confidence: 0.0-0.2<br/>action='PASS'<br/>threat_level='low'"]
    V --> X["ğŸŸ¡ FLAG_LOW Band<br/>Confidence: 0.2-0.4<br/>action='FLAG_LOW'<br/>threat_level='low'"]
    V --> Y["ğŸŸ  FLAG_MEDIUM Band<br/>Confidence: 0.4-0.6<br/>action='FLAG_MEDIUM'<br/>threat_level='medium'"]
    V --> Z["ğŸ”´ FLAG_HIGH Band<br/>Confidence: 0.6-0.8<br/>action='FLAG_HIGH'<br/>threat_level='high'"]
    V --> AA["ğŸŸ£ BLOCK Band<br/>Confidence: 0.8-1.0<br/>action='BLOCK'<br/>threat_level='high'"]
    
    BB["âš™ï¸ Enhanced Configuration"] --> CC["ğŸšï¸ toxicity_threshold = 0.5<br/>ğŸšï¸ finbert_threshold = 0.7<br/>ğŸšï¸ llm_escalation_threshold = 3<br/>ğŸ¯ finbert_bands = 5-layer system"]
    CC --> M
    CC --> V
    
    style C fill:#ffebee
    style I fill:#e8f5e8
    style O fill:#fff8e1
    style U fill:#e1f5fe
    style V fill:#f3e5f5
    style W fill:#c8e6c9
    style X fill:#fff3cd
    style Y fill:#ffe0b3
    style Z fill:#ffcdd2
    style AA fill:#e1bee7
    style H fill:#ffcdd2
    style N fill:#ffcdd2
    style T fill:#c8e6c9
            </div>
        </div>

        <!-- Diagram 3: Enhanced Sequence -->
        <div class="diagram-container">
            <h2 class="diagram-title">ğŸ”„ Advanced Interaction Sequence with Band System<span class="new-feature">UPDATED</span></h2>
            <div class="diagram-description">
                <strong>Real-time communication flow</strong> with enhanced band classification, action determination, and visual feedback including confidence bars and band badges in the frontend.
            </div>
            <div class="mermaid">
sequenceDiagram
    participant User as ğŸ‘¤ User
    participant Frontend as ğŸŒ Frontend v2.0<br/>(Enhanced UI)
    participant API as âš¡ FastAPI Server<br/>(main.py)
    participant Engine as ğŸ›¡ï¸ ModerationEngine v2.0<br/>(moderation.py)
    participant DB as ğŸ—„ï¸ Enhanced Database<br/>(band + action columns)
    participant Keywords as ğŸ“ Keywords File<br/>(2736 words)
    participant AI as ğŸ¤– AI Models<br/>(Detoxify + FinBERT)
    
    User->>Frontend: Enter content in enhanced form
    User->>Frontend: Click "ğŸš€ Submit for Moderation"
    
    Frontend->>Frontend: Enhanced validation & loading state
    Frontend->>API: POST /moderate<br/>{"content": "user text"}
    
    API->>Engine: moderate_content(content)
    
    Engine->>Keywords: Load enhanced keyword list
    Keywords-->>Engine: Return 2736 keywords
    
    Engine->>Engine: Stage 1: Enhanced rule-based check
    
    alt Rule violation found
        Engine-->>API: ModerationResult(band="BLOCK", action="BLOCK")
    else No rule violation
        Engine->>AI: Stage 2: Detoxify check
        AI-->>Engine: Toxicity score
        
        alt High toxicity
            Engine-->>API: ModerationResult(band="BLOCK", action="BLOCK")
        else Low toxicity
            Engine->>AI: Stage 3: Enhanced FinBERT check
            AI-->>Engine: Financial sentiment + confidence
            
            Engine->>Engine: _get_finbert_band() classification
            
            alt Confidence 0.0-0.2
                Engine-->>API: ModerationResult(band="SAFE", action="PASS")
            else Confidence 0.2-0.4
                Engine-->>API: ModerationResult(band="FLAG_LOW", action="FLAG_LOW")
            else Confidence 0.4-0.6
                Engine-->>API: ModerationResult(band="FLAG_MEDIUM", action="FLAG_MEDIUM")
            else Confidence 0.6-0.8
                Engine-->>API: ModerationResult(band="FLAG_HIGH", action="FLAG_HIGH")
            else Confidence 0.8-1.0
                Engine-->>API: ModerationResult(band="BLOCK", action="BLOCK")
            end
        end
    end
    
    API->>DB: Save enhanced Post with band/action
    DB-->>API: Return post ID
    
    API-->>Frontend: Enhanced ModerationResponse<br/>{accepted, reason, band, action, confidence, etc}
    
    Frontend->>Frontend: Display enhanced result UI
    Frontend->>Frontend: Show band badge with color coding
    Frontend->>Frontend: Display confidence bar visualization
    Frontend->>Frontend: Update action status with styling
    
    Frontend->>API: GET /posts (refresh enhanced table)
    API->>DB: Query posts with band/action data
    DB-->>API: Return enhanced posts array
    API-->>Frontend: Posts with band/action metadata
    Frontend->>Frontend: Update table with band badges & confidence
    
    Note over User,AI: Complete enhanced moderation cycle<br/>with 5-layer band classification
            </div>
        </div>

        <!-- Diagram 4: Enhanced Database Operations -->
        <div class="diagram-container">
            <h2 class="diagram-title">ğŸ’¾ Enhanced Database Schema & Operations<span class="new-feature">EXTENDED</span></h2>
            <div class="diagram-description">
                <strong>Extended data persistence</strong> with new band and action columns, enhanced statistics with band breakdown, and comprehensive metadata tracking for the 5-layer classification system.
            </div>
            <div class="mermaid">
graph TD
    A["ğŸš€ FastAPI Application Startup"] --> B["ğŸ—„ï¸ Initialize Enhanced SQLite<br/>moderation.db"]
    
    B --> C["ğŸ“‹ Create Enhanced Post Table"]
    C --> D["ğŸ—ï¸ Enhanced Table: posts<br/>- id (Primary Key)<br/>- content (Text)<br/>- accepted (Boolean)<br/>- reason (Text)<br/>- threat_level (String)<br/>- confidence (String)<br/>ğŸ†• band (String)<br/>ğŸ†• action (String)<br/>- stage (String)<br/>- created_at (DateTime)"]
    
    E["ğŸ“¤ Enhanced Moderation Request"] --> F["ğŸ›¡ï¸ Process with Band System"]
    F --> G["ğŸ“Š Get Enhanced ModerationResult"]
    G --> H["ğŸ’¾ Create Enhanced Post Object"]
    
    H --> I["ğŸ”„ Database Session"]
    I --> J["â• Add Post with Band/Action"]
    J --> K["ğŸ’¾ Commit Enhanced Transaction"]
    K --> L["ğŸ”„ Refresh Post (get ID)"]
    L --> M["ğŸ” Close Session"]
    
    M --> N["ğŸ“ˆ Enhanced API Endpoints"]
    
    N --> O["ğŸ“š GET /posts<br/>Enhanced Post Retrieval"]
    N --> P["ğŸ“Š GET /stats<br/>Band-Aware Statistics"] 
    N --> Q["ğŸ  GET /<br/>Enhanced System Status"]
    N --> R["ğŸ¥ GET /health<br/>Model Status Check"]
    
    O --> S["ğŸ” Query Enhanced Posts<br/>WITH band/action data<br/>ORDER BY created_at DESC"]
    P --> T["ğŸ“ˆ Calculate Enhanced Stats<br/>- Total posts<br/>- Accepted/Rejected counts<br/>- Acceptance rate<br/>- Breakdown by stage<br/>- Threat level distribution<br/>ğŸ†• Band breakdown<br/>ğŸ†• Action statistics"]
    
    S --> U["ğŸ“‹ Return Enhanced JSON<br/>Posts with band badges"]
    T --> V["ğŸ“Š Return Comprehensive Stats<br/>Including band analytics"]
    
    W["ğŸ”§ Enhanced Admin Endpoints"] --> X["ğŸ”„ POST /admin/reload-keywords<br/>Refresh 2736 keywords"]
    W --> Y["âš™ï¸ POST /admin/update-thresholds<br/>Modify AI + Band thresholds"]
    
    Z["ğŸ¯ Band System Data"] --> AA["ğŸ“Š 5-Layer Band Mapping<br/>SAFE: 0.0-0.2<br/>FLAG_LOW: 0.2-0.4<br/>FLAG_MEDIUM: 0.4-0.6<br/>FLAG_HIGH: 0.6-0.8<br/>BLOCK: 0.8-1.0"]
    
    AA --> H
    
    style B fill:#e3f2fd
    style D fill:#f3e5f5
    style H fill:#fff3e0
    style I fill:#e8f5e8
    style N fill:#fff8e1
    style S fill:#f1f8e9
    style T fill:#fce4ec
    style AA fill:#e1f5fe
            </div>
        </div>

        <!-- Diagram 5: Advanced AI Models -->
        <div class="diagram-container">
            <h2 class="diagram-title">ğŸ¤– AI Models with Advanced Band Processing<span class="new-feature">ADVANCED</span></h2>
            <div class="diagram-description">
                <strong>Sophisticated AI processing</strong> featuring the new FinBERT 5-layer band classification system with precise confidence mapping, sentiment analysis, and intelligent action determination.
            </div>
            <div class="mermaid">
graph TD
    A["ğŸ§  Enhanced AI Models Pipeline"] --> B["ğŸ¤– Model Initialization"]
    
    B --> C["ğŸ”´ Detoxify Model<br/>unitary/toxic-bert<br/>Enhanced Processing"]
    B --> D["ğŸ’° FinBERT Model<br/>ProsusAI/finbert<br/>5-Layer Band System"]
    
    C --> E["ğŸ“¥ Load Transformer Model"]
    E --> F["âš™ï¸ Set Device to CPU"]
    F --> G["âœ… Detoxify Ready<br/>Threshold: 0.5"]
    
    D --> H["ğŸ“¥ Load Financial Model"]
    H --> I["âš™ï¸ Set Device to CPU"] 
    I --> J["âœ… FinBERT Ready<br/>Band System Active"]
    
    K["ğŸ“ Input Text"] --> L["ğŸ”´ Stage 2: Enhanced Detoxify"]
    
    L --> M["ğŸ§  Toxicity Classification"]
    M --> N["ğŸ“Š Get Prediction<br/>- Label (toxic/non-toxic)<br/>- Confidence Score (0-1)"]
    N --> O{"ğŸšï¸ Score > 0.5?"}
    
    O -->|Yes| P["âŒ TOXIC DETECTED<br/>band='BLOCK'<br/>action='BLOCK'<br/>threat_level='high/medium'"]
    O -->|No| Q["âœ… CONTINUE TO STAGE 3"]
    
    Q --> R["ğŸ’° Stage 3: Advanced FinBERT"]
    R --> S["ğŸ“ˆ Financial Sentiment Analysis"]
    S --> T["ğŸ“Š Get Enhanced Result<br/>- Sentiment (pos/neg/neutral)<br/>- Confidence Score (0-1)"]
    T --> U{"ğŸ“‰ Negative Sentiment?"}
    
    U -->|No| V["ğŸŸ¢ Non-Financial Content<br/>band='SAFE'<br/>action='PASS'<br/>threat_level='low'"]
    
    U -->|Yes| W["ğŸ¯ _get_finbert_band() Method"]
    W --> X["ğŸ“Š 5-Layer Band Classification"]
    
    X --> Y["ğŸŸ¢ SAFE Band<br/>Confidence: 0.0-0.2<br/>action='PASS'<br/>threat_level='low'"]
    X --> Z["ğŸŸ¡ FLAG_LOW Band<br/>Confidence: 0.2-0.4<br/>action='FLAG_LOW'<br/>threat_level='low'"]
    X --> AA["ğŸŸ  FLAG_MEDIUM Band<br/>Confidence: 0.4-0.6<br/>action='FLAG_MEDIUM'<br/>threat_level='medium'"]
    X --> BB["ğŸ”´ FLAG_HIGH Band<br/>Confidence: 0.6-0.8<br/>action='FLAG_HIGH'<br/>threat_level='high'"]
    X --> CC["ğŸŸ£ BLOCK Band<br/>Confidence: 0.8-1.0<br/>action='BLOCK'<br/>threat_level='high'"]
    
    DD["âš ï¸ Enhanced Error Handling"] --> EE["ğŸ”§ Graceful Model Failures"]
    EE --> FF["ğŸ”„ Smart Fallbacks<br/>- Log detailed warnings<br/>- Continue pipeline<br/>- Return safe defaults<br/>- Maintain band system"]
    
    GG["ğŸ›ï¸ Advanced Configuration"] --> HH["ğŸšï¸ Enhanced Thresholds<br/>- Toxicity: 0.5<br/>- FinBERT: 0.7<br/>- LLM Escalation: 3<br/>ğŸ¯ Band Thresholds<br/>- SAFE: 0.0-0.2<br/>- FLAG_LOW: 0.2-0.4<br/>- FLAG_MEDIUM: 0.4-0.6<br/>- FLAG_HIGH: 0.6-0.8<br/>- BLOCK: 0.8-1.0"]
    
    HH --> O
    HH --> W
    
    style C fill:#ffebee
    style D fill:#fff8e1
    style G fill:#c8e6c9
    style J fill:#c8e6c9
    style P fill:#ffcdd2
    style V fill:#c8e6c9
    style W fill:#e1f5fe
    style X fill:#f3e5f5
    style Y fill:#c8e6c9
    style Z fill:#fff3cd
    style AA fill:#ffe0b3
    style BB fill:#ffcdd2
    style CC fill:#e1bee7
    style EE fill:#fff3e0
    style FF fill:#fff3e0
            </div>
        </div>

        <!-- Diagram 6: Enhanced Architecture -->
        <div class="diagram-container">
            <h2 class="diagram-title">ğŸ—ï¸ Complete Enhanced System Architecture<span class="new-feature">UPGRADED</span></h2>
            <div class="diagram-description">
                <strong>Comprehensive system architecture</strong> showcasing the enhanced layered design with the new band classification system, upgraded UI components, and extended database schema.
            </div>
            <div class="mermaid">
graph TB
    subgraph "ğŸŒ Enhanced Frontend Layer"
        A["ğŸ–¥ï¸ index.html v2.0<br/>- Enhanced content form<br/>- Band badge visualization<br/>- Confidence bar display<br/>- Color-coded action badges<br/>- Real-time result feedback<br/>- Enhanced posts table<br/>- Advanced statistics"]
    end
    
    subgraph "âš¡ Enhanced API Layer (FastAPI)"
        B["ğŸš€ main.py v2.0"]
        C["ğŸ“‹ Core Endpoints<br/>- POST /moderate (enhanced)<br/>- GET /posts (with bands)<br/>- GET /stats (band analytics)<br/>- GET /health (model status)"]
        D["ğŸ”§ Admin Endpoints<br/>- POST /admin/reload-keywords<br/>- POST /admin/update-thresholds<br/>ğŸ†• Band threshold management"]
    end
    
    subgraph "ğŸ›¡ï¸ Enhanced Moderation Engine"
        E["ğŸ¯ GuardianModerationEngine v2.0<br/>(core/moderation.py)"]
        F["ğŸ“‹ Stage 1: Enhanced Rule-Based<br/>- 2736 keywords matching<br/>- Advanced regex patterns<br/>- Enhanced threat detection<br/>- Direct BLOCK classification"]
        G["ğŸ¤– Stage 2: Enhanced Detoxify<br/>- Toxicity classification<br/>- unitary/toxic-bert<br/>- Threshold: 0.5<br/>- BLOCK on detection"]
        H["ğŸ’° Stage 3: Advanced FinBERT<br/>- Financial sentiment analysis<br/>- ProsusAI/finbert<br/>ğŸ†• 5-Layer Band System<br/>ğŸ†• _get_finbert_band() method<br/>ğŸ†• Confidence-based classification"]
    end
    
    subgraph "ğŸ¯ Band Classification System"
        I["ğŸŸ¢ SAFE Band (0.0-0.2)<br/>action='PASS'<br/>threat_level='low'"]
        J["ğŸŸ¡ FLAG_LOW Band (0.2-0.4)<br/>action='FLAG_LOW'<br/>threat_level='low'"]
        K["ğŸŸ  FLAG_MEDIUM Band (0.4-0.6)<br/>action='FLAG_MEDIUM'<br/>threat_level='medium'"]
        L["ğŸ”´ FLAG_HIGH Band (0.6-0.8)<br/>action='FLAG_HIGH'<br/>threat_level='high'"]
        M["ğŸŸ£ BLOCK Band (0.8-1.0)<br/>action='BLOCK'<br/>threat_level='high'"]
    end
    
    subgraph "ğŸ”§ Enhanced Utilities"
        N["âš™ï¸ helpers.py v2.0<br/>- Enhanced keyword loading<br/>- Band-aware operations<br/>- Advanced export functions<br/>- Confidence calculations"]
    end
    
    subgraph "ğŸ’¾ Enhanced Data Layer"
        O["ğŸ“ data/external/words.json<br/>2736 Enhanced Keywords"]
        P["ğŸ—„ï¸ moderation.db v2.0<br/>Enhanced SQLite Schema<br/>- Posts table<br/>ğŸ†• band column<br/>ğŸ†• action column<br/>- Enhanced metadata<br/>- Band analytics support"]
    end
    
    subgraph "ğŸ¤– Advanced AI Models"
        Q["ğŸ§  Enhanced Detoxify<br/>Text Classification<br/>CPU Processing<br/>Threshold Management"]
        R["ğŸ“ˆ Advanced FinBERT<br/>Financial Analysis<br/>5-Layer Classification<br/>Band Determination<br/>CPU Processing"]
    end
    
    subgraph "ğŸ”„ Enhanced Request Flow"
        S["1ï¸âƒ£ Enhanced User Input"] --> T["2ï¸âƒ£ Validated HTTP Request"]
        T --> U["3ï¸âƒ£ Advanced Moderation Pipeline"]
        U --> V["4ï¸âƒ£ Band Classification"]
        V --> W["5ï¸âƒ£ Enhanced Database Storage"]
        W --> X["6ï¸âƒ£ Rich Response Generation"]
        X --> Y["7ï¸âƒ£ Visual Frontend Update"]
    end
    
    A -.-> B
    B --> C
    B --> D
    C --> E
    E --> F
    F --> G
    G --> H
    H --> I
    H --> J
    H --> K
    H --> L
    H --> M
    E --> N
    N --> O
    E --> P
    G --> Q
    H --> R
    
    style A fill:#e1f5fe
    style E fill:#fff3e0
    style F fill:#ffebee
    style G fill:#e8f5e8
    style H fill:#fff8e1
    style I fill:#c8e6c9
    style J fill:#fff3cd
    style K fill:#ffe0b3
    style L fill:#ffcdd2
    style M fill:#e1bee7
    style O fill:#f3e5f5
    style P fill:#e3f2fd
    style Q fill:#e8f5e8
    style R fill:#fff8e1
            </div>
        </div>

        <!-- Diagram 7: Complete Enhanced Data Flow -->
        <div class="diagram-container">
            <h2 class="diagram-title">ğŸ“Š Complete Enhanced End-to-End Data Flow<span class="new-feature">COMPREHENSIVE</span></h2>
            <div class="diagram-description">
                <strong>Ultimate process visualization</strong> showing every step from user input to band classification, including the new 5-layer system, confidence scoring, action determination, and enhanced visual feedback.
            </div>
            <div class="mermaid">
flowchart TD
    Start([ğŸ‘¤ User starts enhanced moderation]) --> Input["ğŸ“ Enter content in enhanced form<br/>(index.html v2.0)"]
    
    Input --> Validate{"ğŸ” Enhanced Validation<br/>Content not empty?"}
    Validate -->|No| Error1["âŒ Show enhanced error"]
    Validate -->|Yes| Submit["ğŸ“¤ Submit enhanced POST /moderate"]
    
    Submit --> Server["âš¡ FastAPI v2.0 receives request<br/>(main.py)"]
    Server --> InitEngine["ğŸ›¡ï¸ Initialize Enhanced Engine v2.0"]
    
    InitEngine --> LoadKeywords["ğŸ“š Load 2736 keywords from<br/>data/external/words.json"]
    LoadKeywords --> LoadModels["ğŸ¤– Load enhanced AI models<br/>Detoxify + FinBERT v2.0"]
    
    LoadModels --> Stage1["ğŸ“‹ STAGE 1: Enhanced Rule-Based"]
    Stage1 --> CheckKeywords["ğŸ” Enhanced keyword matching<br/>Whole word + case insensitive"]
    CheckKeywords --> CheckRegex["ğŸ¯ Advanced regex patterns<br/>URLs, emails, threats, violence"]
    
    CheckRegex --> Rule1{"â“ Rule violations detected?"}
    Rule1 -->|Yes| Reject1["âŒ IMMEDIATE BLOCK<br/>Band: BLOCK<br/>Action: BLOCK<br/>Threat: High<br/>Confidence: 1.0"]
    Rule1 -->|No| Stage2["ğŸ¤– STAGE 2: Enhanced Detoxify"]
    
    Stage2 --> Detoxify["ğŸ§  Process with enhanced toxic-bert"]
    Detoxify --> ToxicScore["ğŸ“Š Get toxicity score (0-1)"]
    ToxicScore --> Toxic1{"ğŸšï¸ Score > 0.5 threshold?"}
    
    Toxic1 -->|Yes| Reject2["âŒ TOXICITY BLOCK<br/>Band: BLOCK<br/>Action: BLOCK<br/>Threat: Medium/High<br/>Confidence: Score"]
    Toxic1 -->|No| Stage3["ğŸ’° STAGE 3: Advanced FinBERT"]
    
    Stage3 --> FinBERT["ğŸ“ˆ Process with enhanced FinBERT"]
    FinBERT --> FinSentiment["ğŸ“Š Get financial sentiment + confidence"]
    FinSentiment --> SentimentCheck{"ğŸ“‰ Negative sentiment?"}
    
    SentimentCheck -->|No| SafeResult["ğŸŸ¢ NON-FINANCIAL SAFE<br/>Band: SAFE<br/>Action: PASS<br/>Threat: Low"]
    
    SentimentCheck -->|Yes| BandClass["ğŸ¯ _get_finbert_band() classification"]
    BandClass --> BandLogic{"ğŸ“Š Confidence-based banding"}
    
    BandLogic --> Band1["ğŸŸ¢ SAFE Band<br/>Confidence: 0.0-0.2<br/>Action: PASS<br/>Threat: Low<br/>âœ… ACCEPT"]
    BandLogic --> Band2["ğŸŸ¡ FLAG_LOW Band<br/>Confidence: 0.2-0.4<br/>Action: FLAG_LOW<br/>Threat: Low<br/>âœ… ACCEPT"]
    BandLogic --> Band3["ğŸŸ  FLAG_MEDIUM Band<br/>Confidence: 0.4-0.6<br/>Action: FLAG_MEDIUM<br/>Threat: Medium<br/>âœ… ACCEPT"]
    BandLogic --> Band4["ğŸ”´ FLAG_HIGH Band<br/>Confidence: 0.6-0.8<br/>Action: FLAG_HIGH<br/>Threat: High<br/>âœ… ACCEPT"]
    BandLogic --> Band5["ğŸŸ£ BLOCK Band<br/>Confidence: 0.8-1.0<br/>Action: BLOCK<br/>Threat: High<br/>âŒ REJECT"]
    
    Reject1 --> SaveDB["ğŸ’¾ Save to enhanced database<br/>with band + action columns"]
    Reject2 --> SaveDB
    SafeResult --> SaveDB
    Band1 --> SaveDB
    Band2 --> SaveDB
    Band3 --> SaveDB
    Band4 --> SaveDB
    Band5 --> SaveDB
    
    SaveDB --> CreatePost["ğŸ—ï¸ Create enhanced Post record<br/>with band/action metadata"]
    CreatePost --> GetID["ğŸ†” Get assigned post ID"]
    GetID --> Response["ğŸ“Š Create enhanced ModerationResponse<br/>JSON with band/action/confidence"]
    
    Response --> Frontend["ğŸŒ Send to enhanced frontend"]
    Frontend --> DisplayResult["ğŸ“º Display enhanced result<br/>Band badges + confidence bars"]
    DisplayResult --> UpdateTable["ğŸ”„ Refresh enhanced posts table<br/>GET /posts with bands"]
    
    UpdateTable --> ShowStats["ğŸ“ˆ Update enhanced statistics<br/>GET /stats with band analytics"]
    ShowStats --> VisualFeedback["ğŸ¨ Show visual feedback<br/>Color-coded bands + actions"]
    VisualFeedback --> End([âœ… Enhanced process complete])
    
    Error1 --> End
    
    style Input fill:#e1f5fe
    style Stage1 fill:#ffebee
    style Stage2 fill:#e8f5e8
    style Stage3 fill:#fff8e1
    style BandClass fill:#e1f5fe
    style Band1 fill:#c8e6c9
    style Band2 fill:#fff3cd
    style Band3 fill:#ffe0b3
    style Band4 fill:#ffcdd2
    style Band5 fill:#e1bee7
    style Reject1 fill:#ffcdd2
    style Reject2 fill:#ffcdd2
    style SafeResult fill:#c8e6c9
    style SaveDB fill:#e3f2fd
    style DisplayResult fill:#f1f8e9
    style VisualFeedback fill:#e8f5e8
            </div>
        </div>

        <!-- Diagram 8: Complete Multi-Stage Moderation Pipeline -->
        <div class="diagram-container">
            <h2 class="diagram-title">ğŸ”§ Complete Multi-Stage Moderation Pipeline v3.0<span class="new-feature">CURRENT SYSTEM</span></h2>
            <div class="diagram-description">
                <strong>Current 5-stage modular pipeline</strong> with lexical filtering, toxicity detection, sentiment analysis, fraud classification, and LLM escalation with chain-of-thought reasoning.
            </div>
            <div class="mermaid">
graph TD
    A["ğŸ›¡ï¸ ModerationPipeline.process()"] --> B["ğŸ“ Input: Content String"]
    
    B --> C["ğŸ”´ Stage 1: Lexical Filter<br/>Stage1LexicalFilter"]
    C --> D["ğŸ“š Load 2,736 keywords<br/>data/external/words.json"]
    D --> E["ğŸ” Fuzzy keyword matching<br/>Whole word + case insensitive"]
    E --> F["ğŸ¯ Regex pattern matching<br/>Crypto addresses, URLs, threats"]
    F --> G{"â“ Rule violations?"}
    
    G -->|Yes| H["âŒ BLOCK<br/>decision='BLOCK'<br/>stage='stage1'<br/>confidence=0.8-1.0"]
    
    G -->|No| I["ğŸŸ¡ Stage 2: Toxicity Check<br/>Stage2ToxicityCheck"]
    I --> J["ğŸ¤– Detoxify Model<br/>unitary/toxic-bert"]
    J --> K["ğŸ§  Toxicity classification<br/>Score (0-1)"]
    K --> L{"ğŸšï¸ Score > 0.5?"}
    
    L -->|Yes| M["âŒ BLOCK<br/>decision='BLOCK'<br/>stage='stage2'<br/>confidence=score"]
    
    L -->|No| N["ğŸŸ¢ Stage 3a: Sentiment Sentinels<br/>Stage3aSentimentSentinels"]
    N --> O["ğŸ’° FinBERT Model<br/>ProsusAI/finbert"]
    O --> P["ğŸ“ˆ Financial sentiment analysis<br/>positive/negative/neutral"]
    P --> Q["ğŸ“Š Store sentiment in context<br/>metadata for Stage 3b"]
    Q --> R["âœ… ACCEPT/CONTINUE<br/>Pass to next stage"]
    
    R --> S["ğŸ” Stage 3b: Fraud Classifier<br/>Stage3bFraudClassifier"]
    S --> T["ğŸ¯ CiferAI Model<br/>CiferAI/cifer-fraud-detection"]
    T --> U["ğŸ”§ Heuristic fraud detection<br/>Patterns + rules"]
    U --> V["ğŸ“Š Ensemble voting<br/>Combine scores"]
    V --> W{"ğŸ² Fraud probability?"}
    
    W -->|High| X["âŒ BLOCK<br/>decision='BLOCK'<br/>stage='stage3b'<br/>confidence=score"]
    W -->|Medium| Y["âš ï¸ ESCALATE<br/>decision='ESCALATE'<br/>stage='stage3b'<br/>confidence=score"]
    W -->|Low| Z["âœ… ACCEPT/CONTINUE<br/>Pass to LLM stage"]
    
    Z --> AA["ğŸ§  LLM Escalation<br/>LLMEscalation"]
    AA --> BB["ğŸ”— Chain-of-Thought reasoning<br/>Context from all stages"]
    BB --> CC["ğŸ¤– Groq API call<br/>llama3-8b-8192"]
    CC --> DD["ğŸ¯ LLM decision<br/>FRAUD/CLEAN/UNCERTAIN"]
    DD --> EE{"ğŸ§  LLM result?"}
    
    EE -->|FRAUD| FF["âŒ BLOCK<br/>decision='BLOCK'<br/>stage='llm'<br/>confidence=0.9"]
    EE -->|CLEAN| GG["âœ… ACCEPT<br/>decision='ACCEPT'<br/>stage='llm'<br/>confidence=0.9"]
    EE -->|UNCERTAIN| HH["âŒ BLOCK<br/>decision='BLOCK'<br/>stage='llm'<br/>confidence=0.5"]
    
    H --> II["ğŸ“Š Return ModerationResult"]
    M --> II
    X --> II
    Y --> II
    FF --> II
    GG --> II
    HH --> II
    
    II --> JJ["ğŸ’¾ Database storage<br/>Post model with metadata"]
    JJ --> KK["ğŸ“¤ API response<br/>ModerationResponse"]
    
    style C fill:#ffebee
    style I fill:#e8f5e8
    style N fill:#fff8e1
    style S fill:#e1f5fe
    style AA fill:#f3e5f5
    style H fill:#ffcdd2
    style M fill:#ffcdd2
    style X fill:#ffcdd2
    style Y fill:#ffe0b3
    style FF fill:#ffcdd2
    style GG fill:#c8e6c9
    style HH fill:#ffcdd2
    style JJ fill:#e3f2fd
            </div>
        </div>

        <!-- Diagram 9: API Architecture and Endpoints -->
        <div class="diagram-container">
            <h2 class="diagram-title">ğŸŒ FastAPI Architecture & Endpoints<span class="new-feature">COMPREHENSIVE</span></h2>
            <div class="diagram-description">
                <strong>Complete API structure</strong> with all endpoints, request/response models, database integration, and pipeline processing.
            </div>
            <div class="mermaid">
graph TD
    A["ğŸš€ FastAPI Application<br/>main.py"] --> B["ğŸ”§ CORS Middleware<br/>allow_origins=['*']"]
    B --> C["ğŸ“‹ Database Setup<br/>SQLite + SQLAlchemy"]
    C --> D["ğŸ›¡ï¸ Pipeline Initialization<br/>create_default_pipeline()"]
    
    D --> E["ğŸŒ API Endpoints"]
    
    E --> F["ğŸ  GET /<br/>System status & info"]
    E --> G["ğŸ¥ GET /health<br/>Health check"]
    E --> H["ğŸ›¡ï¸ POST /moderate<br/>Main moderation endpoint"]
    E --> I["ğŸ“‹ GET /posts<br/>Retrieve all posts"]
    E --> J["ğŸ“Š GET /stats<br/>System statistics"]
    E --> K["ğŸ”§ GET /pipeline/stages<br/>Pipeline information"]
    
    H --> L["ğŸ“ ModerationRequest<br/>content: str"]
    L --> M["ğŸ›¡ï¸ Pipeline Processing<br/>moderation_pipeline.process()"]
    M --> N["ğŸ¤– LLM Explanation<br/>get_llm_explanation_and_suggestion()"]
    N --> O["ğŸ’¾ Database Storage<br/>Post model creation"]
    O --> P["ğŸ“¤ ModerationResponse<br/>decision, stage, reason, etc."]
    
    I --> Q["ğŸ—„ï¸ Database Query<br/>Post.query().order_by(created_at.desc())"]
    Q --> R["ğŸ“‹ Posts Array<br/>JSON response"]
    
    J --> S["ğŸ“Š Statistics Calculation<br/>Total, accepted, rejected"]
    S --> T["ğŸ“ˆ Advanced Stats<br/>By decision, stage, threat level"]
    T --> U["ğŸ“Š Stats Response<br/>JSON with analytics"]
    
    V["ğŸ—„ï¸ Database Models"] --> W["ğŸ“„ Post Table<br/>- id, content, accepted<br/>- decision, stage, confidence<br/>- threat_level, action<br/>- financial_risk_band<br/>- llm_explanation, etc."]
    
    X["ğŸ”‘ Environment Variables"] --> Y["ğŸ¤– GROQ_API_KEY<br/>LLM integration"]
    Y --> Z["ğŸ” ModerationAPP<br/>CiferAI token"]
    
    W --> O
    N --> AA["ğŸŒ Groq API<br/>llama3-8b-8192"]
    AA --> BB["ğŸ“ Chain-of-Thought<br/>JSON response"]
    
    style A fill:#e1f5fe
    style D fill:#fff3e0
    style E fill:#f3e5f5
    style H fill:#fff8e1
    style M fill:#ffebee
    style N fill:#e8f5e8
    style O fill:#e3f2fd
    style W fill:#f3e5f5
    style AA fill:#e1f5fe
            </div>
        </div>

        <!-- Diagram 10: Database Schema and Data Flow -->
        <div class="diagram-container">
            <h2 class="diagram-title">ğŸ’¾ Database Schema & Data Flow<span class="new-feature">DETAILED</span></h2>
            <div class="diagram-description">
                <strong>Complete database design</strong> with Post model structure, data relationships, and statistics generation flow.
            </div>
            <div class="mermaid">
graph TD
    A["ğŸ—„ï¸ SQLite Database<br/>moderation.db"] --> B["ğŸ“„ Post Table Schema"]
    
    B --> C["ğŸ†” Primary Key<br/>id: Integer (auto-increment)"]
    B --> D["ğŸ“ Content Fields<br/>content: Text (not null)"]
    B --> E["âœ… Decision Fields<br/>accepted: Boolean<br/>decision: String (ACCEPT/BLOCK/ESCALATE)"]
    B --> F["ğŸ”§ Processing Fields<br/>stage: String<br/>reason: Text<br/>confidence: String"]
    B --> G["âš ï¸ Risk Assessment<br/>threat_level: String<br/>action: String<br/>financial_risk_band: String"]
    B --> H["ğŸ¤– LLM Fields<br/>llm_explanation: Text<br/>llm_troublesome_words: Text<br/>llm_suggestion: Text"]
    B --> I["â° Timestamp<br/>created_at: DateTime"]
    
    J["ğŸ“¤ Moderation Request"] --> K["ğŸ›¡ï¸ Pipeline Processing"]
    K --> L["ğŸ“Š ModerationResult"]
    L --> M["ğŸ¤– LLM Enhancement<br/>get_llm_explanation_and_suggestion()"]
    M --> N["ğŸ—ï¸ Post Creation"]
    
    N --> O["ğŸ’¾ Database Insert<br/>SessionLocal()"]
    O --> P["ğŸ”„ Commit Transaction"]
    P --> Q["ğŸ”„ Refresh for ID"]
    Q --> R["ğŸ“¤ Response Generation"]
    
    S["ğŸ“Š Statistics Queries"] --> T["ğŸ“ˆ Basic Stats<br/>COUNT(), GROUP BY"]
    T --> U["ğŸ¯ Decision Breakdown<br/>ACCEPT/BLOCK/ESCALATE counts"]
    U --> V["ğŸ·ï¸ Stage Analysis<br/>stage1/stage2/stage3a/stage3b/llm"]
    V --> W["âš ï¸ Threat Level Distribution<br/>low/medium/high"]
    W --> X["ğŸ“Š Pipeline Information<br/>Total stages, stage names"]
    
    Y["ğŸ“‹ Posts Retrieval"] --> Z["ğŸ“‘ ORDER BY created_at DESC"]
    Z --> AA["ğŸ“¤ JSON Response<br/>Array of posts"]
    
    BB["ğŸ”§ Database Operations"] --> CC["ğŸ“ Create (INSERT)"]
    BB --> DD["ğŸ“– Read (SELECT)"]
    BB --> EE["ğŸ“Š Aggregate (COUNT, GROUP BY)"]
    
    style A fill:#e3f2fd
    style B fill:#f3e5f5
    style K fill:#fff3e0
    style L fill:#fff8e1
    style M fill:#e8f5e8
    style N fill:#e1f5fe
    style O fill:#e3f2fd
    style S fill:#fce4ec
    style T fill:#f1f8e9
    style Y fill:#fff3e0
            </div>
        </div>

        <!-- Diagram 11: Frontend-Backend Interaction Flow -->
        <div class="diagram-container">
            <h2 class="diagram-title">ğŸ–¥ï¸ Frontend-Backend User Journey<span class="new-feature">INTERACTIVE</span></h2>
            <div class="diagram-description">
                <strong>Complete user interaction flow</strong> from content submission through processing to result display with enhanced UI feedback.
            </div>
            <div class="mermaid">
sequenceDiagram
    participant User as ğŸ‘¤ User
    participant Frontend as ğŸŒ Frontend<br/>(index.html)
    participant API as âš¡ FastAPI Server<br/>(main.py)
    participant Pipeline as ğŸ›¡ï¸ Moderation Pipeline<br/>(5 stages)
    participant LLM as ğŸ¤– LLM Service<br/>(Groq API)
    participant DB as ğŸ’¾ Database<br/>(SQLite)
    
    User->>Frontend: ğŸ“ Enter content in textarea
    User->>Frontend: ğŸš€ Click "Submit for Moderation"
    
    Frontend->>Frontend: âœ… Validate input (not empty)
    Frontend->>Frontend: ğŸ”„ Show loading state
    Frontend->>API: ğŸ“¤ POST /moderate<br/>{"content": "user text"}
    
    API->>Pipeline: ğŸ›¡ï¸ moderation_pipeline.process(content)
    
    Pipeline->>Pipeline: ğŸ”´ Stage 1: Lexical Filter
    Pipeline->>Pipeline: ğŸŸ¡ Stage 2: Toxicity Check
    Pipeline->>Pipeline: ğŸŸ¢ Stage 3a: Sentiment Analysis
    Pipeline->>Pipeline: ğŸ” Stage 3b: Fraud Detection
    Pipeline->>Pipeline: ğŸ§  LLM Escalation
    
    Pipeline-->>API: ğŸ“Š ModerationResult
    
    alt Content was blocked
        API->>LLM: ğŸ¤– get_llm_explanation_and_suggestion()
        LLM-->>API: ğŸ“ Explanation, words, suggestion
    end
    
    API->>DB: ğŸ’¾ Save Post with all metadata
    DB-->>API: ğŸ†” Return post ID
    
    API-->>Frontend: ğŸ“¤ ModerationResponse<br/>{decision, stage, reason, confidence, etc.}
    
    Frontend->>Frontend: ğŸ¨ Display result with styling
    Frontend->>Frontend: ğŸ“Š Show confidence bars
    Frontend->>Frontend: ğŸ·ï¸ Display risk bands and actions
    
    alt Show explanation for blocked content
        Frontend->>Frontend: ğŸ’¡ Display LLM explanation
        Frontend->>Frontend: ğŸ” Highlight troublesome words
        Frontend->>Frontend: ğŸ’­ Show suggested alternative
    end
    
    Frontend->>API: ğŸ“‹ GET /posts (refresh table)
    API->>DB: ğŸ” Query recent posts
    DB-->>API: ğŸ“„ Posts array
    API-->>Frontend: ğŸ“‹ Posts with metadata
    
    Frontend->>Frontend: ğŸ“Š Update posts table
    Frontend->>Frontend: ğŸ¯ Show band badges
    Frontend->>Frontend: â° Display timestamps
    
    Frontend->>API: ğŸ“ˆ GET /stats (update statistics)
    API->>DB: ğŸ“Š Calculate statistics
    DB-->>API: ğŸ“ˆ Stats data
    API-->>Frontend: ğŸ“Š Statistics response
    
    Frontend->>Frontend: ğŸ“ˆ Update stats display
    Frontend->>Frontend: ğŸ“Š Show acceptance rates
    Frontend->>Frontend: ğŸ¯ Display stage breakdown
    
    Note over User,DB: Complete moderation cycle<br/>with 5-stage pipeline & LLM enhancement
            </div>
        </div>

        <!-- Diagram 12: System Architecture Overview -->
        <div class="diagram-container">
            <h2 class="diagram-title">ğŸ—ï¸ Complete System Architecture v3.0<span class="new-feature">COMPREHENSIVE</span></h2>
            <div class="diagram-description">
                <strong>Full system architecture</strong> showing all components, layers, data flows, and integrations in the current GuardianAI system.
            </div>
            <div class="mermaid">
graph TB
    subgraph "ğŸŒ Frontend Layer"
        A["ğŸ–¥ï¸ HTML5 Interface<br/>index.html"]
        B["âš›ï¸ React App<br/>material-ui-app<br/>(Basic template)"]
    end
    
    subgraph "ğŸ”Œ API Layer"
        C["âš¡ FastAPI Server<br/>main.py"]
        D["ğŸ›¡ï¸ POST /moderate<br/>Main processing"]
        E["ğŸ“‹ GET /posts<br/>Data retrieval"]
        F["ğŸ“Š GET /stats<br/>Analytics"]
        G["ğŸ¥ GET /health<br/>Status check"]
        H["ğŸ”§ GET /pipeline/stages<br/>Pipeline info"]
    end
    
    subgraph "ğŸ›¡ï¸ Moderation Engine"
        I["ğŸ”´ Stage 1: Lexical Filter<br/>Keywords + Regex"]
        J["ğŸŸ¡ Stage 2: Toxicity Check<br/>Detoxify (unitary/toxic-bert)"]
        K["ğŸŸ¢ Stage 3a: Sentiment Analysis<br/>FinBERT (ProsusAI/finbert)"]
        L["ğŸ” Stage 3b: Fraud Detection<br/>CiferAI + Heuristics"]
        M["ğŸ§  LLM Escalation<br/>Chain-of-Thought"]
    end
    
    subgraph "ğŸ¤– AI Models & Services"
        N["ğŸ§  Detoxify Model<br/>Text Classification"]
        O["ğŸ’° FinBERT Model<br/>Financial Sentiment"]
        P["ğŸ¯ CiferAI Model<br/>Fraud Detection"]
        Q["ğŸ¤– Groq API<br/>llama3-8b-8192"]
    end
    
    subgraph "ğŸ’¾ Data Layer"
        R["ğŸ—„ï¸ SQLite Database<br/>moderation.db"]
        S["ğŸ“„ Post Table<br/>Complete metadata"]
        T["ğŸ“ Keywords File<br/>data/external/words.json<br/>2,736 terms"]
    end
    
    subgraph "ğŸ”§ Configuration"
        U["âš™ï¸ Environment Variables<br/>GROQ_API_KEY, ModerationAPP"]
        V["ğŸ”‘ API Keys<br/>External services"]
        W["ğŸ“Š Thresholds<br/>Toxicity, confidence, etc."]
    end
    
    subgraph "ğŸ”„ Data Flow"
        X["ğŸ“¥ Input Processing"]
        Y["ğŸ›¡ï¸ Multi-Stage Analysis"]
        Z["ğŸ“Š Result Generation"]
        AA["ğŸ’¾ Data Persistence"]
        BB["ğŸ“¤ Response Delivery"]
    end
    
    A --> C
    B --> C
    C --> D
    D --> I
    I --> J
    J --> K
    K --> L
    L --> M
    
    J --> N
    K --> O
    L --> P
    M --> Q
    
    D --> R
    R --> S
    I --> T
    
    Q --> U
    P --> V
    N --> W
    
    X --> Y
    Y --> Z
    Z --> AA
    AA --> BB
    
    style A fill:#e1f5fe
    style C fill:#f3e5f5
    style D fill:#fff8e1
    style I fill:#ffebee
    style J fill:#e8f5e8
    style K fill:#fff8e1
    style L fill:#e1f5fe
    style M fill:#f3e5f5
    style N fill:#e8f5e8
    style R fill:#e3f2fd
    style S fill:#f3e5f5
    style T fill:#fff3e0
            </div>
        </div>

        <!-- Diagram 13: Error Handling and Escalation Flow -->
        <div class="diagram-container">
            <h2 class="diagram-title">âš ï¸ Error Handling & Escalation Flow<span class="new-feature">RESILIENT</span></h2>
            <div class="diagram-description">
                <strong>Comprehensive error handling</strong> with graceful degradation, fallback mechanisms, and escalation paths for model failures.
            </div>
            <div class="mermaid">
graph TD
    A["ğŸ›¡ï¸ Pipeline Processing Start"] --> B["ğŸ“ Content Input"]
    
    B --> C["ğŸ”´ Stage 1: Lexical Filter"]
    C --> D{"â“ Keywords file load error?"}
    D -->|Yes| E["âš ï¸ Log warning<br/>Use fallback keywords"]
    D -->|No| F["âœ… Process with full keywords"]
    E --> F
    
    F --> G["ğŸŸ¡ Stage 2: Toxicity Check"]
    G --> H{"â“ Detoxify model error?"}
    H -->|Yes| I["âš ï¸ Log warning<br/>Skip toxicity check<br/>Continue pipeline"]
    H -->|No| J["âœ… Process with Detoxify"]
    I --> K["ğŸŸ¢ Stage 3a: Sentiment Analysis"]
    J --> K
    
    K --> L{"â“ FinBERT model error?"}
    L -->|Yes| M["âš ï¸ Log warning<br/>Skip sentiment analysis<br/>Continue pipeline"]
    L -->|No| N["âœ… Process with FinBERT"]
    M --> O["ğŸ” Stage 3b: Fraud Detection"]
    N --> O
    
    O --> P{"â“ CiferAI model error?"}
    P -->|Yes| Q["âš ï¸ Fallback to heuristics<br/>Log CiferAI failure"]
    P -->|No| R["âœ… Process with CiferAI"]
    Q --> S["ğŸ”§ Enhanced heuristic detection"]
    R --> S
    
    S --> T["ğŸ§  LLM Escalation"]
    T --> U{"â“ Groq API error?"}
    U -->|Yes| V["âš ï¸ API timeout/failure<br/>Log LLM error"]
    U -->|No| W["âœ… Process with LLM"]
    
    V --> X["ğŸ”„ Default safe behavior<br/>Return conservative result"]
    W --> Y["ğŸ“Š Generate ModerationResult"]
    X --> Y
    
    Y --> Z["ğŸ’¾ Database Storage"]
    Z --> AA{"â“ Database error?"}
    AA -->|Yes| BB["âŒ HTTPException 500<br/>Log database error"]
    AA -->|No| CC["âœ… Store successfully"]
    
    DD["ğŸš¨ Error Types"] --> EE["ğŸ”Œ Network errors<br/>API timeouts"]
    DD --> FF["ğŸ¤– Model loading failures<br/>Memory issues"]
    DD --> GG["ğŸ—„ï¸ Database connection errors<br/>Disk space issues"]
    DD --> HH["ğŸ”‘ Authentication failures<br/>Invalid API keys"]
    
    II["ğŸ“‹ Logging Strategy"] --> JJ["âš ï¸ Warning level<br/>Model failures"]
    II --> KK["âŒ Error level<br/>Critical failures"]
    II --> LL["ğŸ“Š Info level<br/>Successful operations"]
    
    MM["ğŸ”„ Fallback Mechanisms"] --> NN["ğŸ”§ Heuristic-only processing<br/>When AI models fail"]
    MM --> OO["âš™ï¸ Default safe responses<br/>Conservative decisions"]
    MM --> PP["ğŸ“ Detailed error logging<br/>For debugging"]
    
    style A fill:#e1f5fe
    style C fill:#ffebee
    style G fill:#e8f5e8
    style K fill:#fff8e1
    style O fill:#e1f5fe
    style T fill:#f3e5f5
    style E fill:#fff3cd
    style I fill:#fff3cd
    style M fill:#fff3cd
    style Q fill:#fff3cd
    style V fill:#fff3cd
    style X fill:#ffe0b3
    style BB fill:#ffcdd2
    style DD fill:#c8e6c9
            </div>
        </div>

        <!-- Diagram 14: LLM Integration and Chain-of-Thought -->
        <div class="diagram-container">
            <h2 class="diagram-title">ğŸ§  LLM Integration & Chain-of-Thought<span class="new-feature">INTELLIGENT</span></h2>
            <div class="diagram-description">
                <strong>Advanced LLM integration</strong> with chain-of-thought reasoning, context awareness, and dual-purpose explanations for blocked content.
            </div>
            <div class="mermaid">
graph TD
    A["ğŸ§  LLM Integration Points"] --> B["ğŸ›¡ï¸ Pipeline Escalation<br/>LLMEscalation stage"]
    A --> C["ğŸ’¡ Content Explanation<br/>get_llm_explanation_and_suggestion()"]
    
    B --> D["ğŸ”— Chain-of-Thought Process"]
    D --> E["ğŸ“Š Context Building<br/>Previous stage results"]
    E --> F["ğŸ“ Prompt Engineering<br/>Financial police context"]
    F --> G["ğŸ¯ Decision Criteria<br/>Fraud vs. normal content"]
    G --> H["ğŸ¤– Groq API Call<br/>llama3-8b-8192"]
    
    H --> I["ğŸ“¤ LLM Response<br/>FRAUD/CLEAN/UNCERTAIN"]
    I --> J{"ğŸ¯ Decision Processing"}
    J -->|FRAUD| K["âŒ BLOCK<br/>High confidence"]
    J -->|CLEAN| L["âœ… ACCEPT<br/>High confidence"]
    J -->|UNCERTAIN| M["âŒ BLOCK<br/>Conservative approach"]
    
    C --> N["ğŸ“‹ Explanation Generation"]
    N --> O["ğŸ“ User-Friendly Language<br/>No technical jargon"]
    O --> P["ğŸ” Problem Word Identification<br/>Exact phrases"]
    P --> Q["ğŸ’­ Alternative Suggestions<br/>Constructive feedback"]
    Q --> R["ğŸ“Š JSON Response<br/>Structured output"]
    
    S["ğŸ›ï¸ Prompt Engineering"] --> T["ğŸ”§ Context Awareness<br/>Previous stage results"]
    S --> U["ğŸ¯ Role Definition<br/>Financial police"]
    S --> V["ğŸ“‹ Clear Instructions<br/>Specific criteria"]
    S --> W["ğŸ”„ Consistency<br/>Repeatable results"]
    
    X["âš™ï¸ Configuration"] --> Y["ğŸ”‘ API Key Management<br/>GROQ_API_KEY"]
    X --> Z["ğŸ“Š Model Settings<br/>llama3-8b-8192"]
    X --> AA["ğŸšï¸ Temperature: 0.1<br/>Low variability"]
    X --> BB["ğŸ“ Max tokens: 200<br/>Controlled output"]
    
    CC["ğŸ”„ Error Handling"] --> DD["â±ï¸ Timeout handling<br/>30 seconds"]
    CC --> EE["ğŸ”„ Retry logic<br/>Graceful degradation"]
    CC --> FF["ğŸ“Š Fallback responses<br/>Default safe behavior"]
    
    GG["ğŸ“Š Response Processing"] --> HH["ğŸ“ Text parsing<br/>Extract decisions"]
    GG --> II["ğŸ¯ Confidence scoring<br/>0.9 for clear decisions"]
    GG --> JJ["âš ï¸ Uncertainty handling<br/>Default to blocking"]
    
    KK["ğŸ’¡ Dual LLM Usage"] --> LL["ğŸ›¡ï¸ Moderation Decision<br/>In pipeline"]
    KK --> MM["ğŸ“ User Explanation<br/>After blocking"]
    KK --> NN["ğŸ¯ Different prompts<br/>Different purposes"]
    
    style A fill:#e1f5fe
    style B fill:#f3e5f5
    style C fill:#fff8e1
    style D fill:#e8f5e8
    style H fill:#f3e5f5
    style I fill:#fff3e0
    style K fill:#ffcdd2
    style L fill:#c8e6c9
    style M fill:#ffcdd2
    style N fill:#e8f5e8
    style R fill:#c8e6c9
    style S fill:#fff3e0
    style X fill:#e3f2fd
    style CC fill:#fff3cd
    style GG fill:#f1f8e9
    style KK fill:#e1f5fe
            </div>
        </div>

    </div>

    <button class="back-to-top" onclick="scrollToTop()">â¬†ï¸</button>

    <script>
        // Initialize Mermaid with enhanced settings
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                diagramMarginX: 50,
                diagramMarginY: 10,
                actorMargin: 50,
                width: 150,
                height: 65,
                boxMargin: 10,
                boxTextMargin: 5,
                noteMargin: 10,
                messageMargin: 35
            }
        });

        // Enhanced back to top functionality
        window.addEventListener('scroll', function() {
            const backToTop = document.querySelector('.back-to-top');
            if (window.pageYOffset > 300) {
                backToTop.style.display = 'block';
                backToTop.style.opacity = '1';
            } else {
                backToTop.style.display = 'none';
                backToTop.style.opacity = '0';
            }
        });

        function scrollToTop() {
            window.scrollTo({ 
                top: 0, 
                behavior: 'smooth' 
            });
        }

        // Enhanced console logging
        console.log('ğŸ‰ Enhanced Content Moderation Engine v3.0 - All Diagrams Loaded!');
        console.log('ğŸ“Š 14 comprehensive diagrams with 5-stage modular pipeline');
        console.log('ğŸ¯ Features: Multi-stage processing, LLM integration, comprehensive error handling');
        console.log('ğŸ”„ Scroll to view all enhanced diagrams');
        
        // Add smooth scroll behavior for better UX
        document.documentElement.style.scrollBehavior = 'smooth';
    </script>
</body>
</html> 