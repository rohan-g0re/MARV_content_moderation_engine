<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Moderation Engine - Updated Architecture Diagrams</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.2em;
            margin-bottom: 20px;
        }

        .upgrade-badge {
            background: linear-gradient(45deg, #ff6b6b, #ffa726);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            display: inline-block;
            margin: 10px 5px;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .stat-item {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .diagram-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .diagram-title {
            color: #2c3e50;
            font-size: 1.8em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .diagram-description {
            color: #7f8c8d;
            margin-bottom: 25px;
            font-size: 1.1em;
            line-height: 1.6;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .new-feature {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
            margin-left: 8px;
        }

        .mermaid {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            font-size: 18px;
        }

        .back-to-top:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .stats {
                gap: 15px;
            }
            
            .diagram-container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üõ°Ô∏è Content Moderation Engine v2.0</h1>
            <p class="subtitle">Enhanced Architecture with 5-Layer Band System</p>
            <div style="margin: 15px 0;">
                <span class="upgrade-badge">üìä Action Classification</span>
                <span class="upgrade-badge">üé® Enhanced UI</span>
                <span class="upgrade-badge">üíæ Extended Database</span>
                <span class="upgrade-badge">üéØ Real time analytics</span>
            </div>
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-number">5</span>
                    <span class="stat-label">ModerationStages</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">5</span>
                    <span class="stat-label">Risk Bands</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">2736</span>
                    <span class="stat-label">Keywords</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">100%</span>
                    <span class="stat-label">Coverage</span>
                </div>
            </div>
        </header>

        <!-- Diagram 1: Enhanced System Overview -->
        <div class="diagram-container">
            <h2 class="diagram-title">üåü Enhanced System Flow with 5-Stage Pipeline<span class="new-feature">NEW</span></h2>
            <div class="diagram-description">
                <strong>Complete user journey</strong> with the new 5-stage moderation pipeline (Stage1_RuleBased, Stage2_LGBM, Stage3_Detoxify, Stage4_FinBert, Stage5_LLM) and enhanced action classification. Shows sophisticated risk assessment and visual feedback.
            </div>
            <div class="mermaid">
graph TD
    A["üåê Frontend<br/>index.html<br/>Enhanced UI"] --> B["üì§ User Input<br/>Content Submission"]
    B --> C["üöÄ HTTP POST Request<br/>/moderate"]
    C --> D["‚ö° FastAPI Server<br/>main.py:app"]
    
    D --> E["üõ°Ô∏è GuardianModerationEngine v2.1<br/>core/moderation.py"]
    
    E --> F["üìã Stage1_RuleBased<br/>Keywords + Regex"]
    F --> G{"üîç Keywords/Patterns Found?"}
    G -->|Yes| H["‚ùå BLOCK<br/>Band: BLOCK<br/>Action: BLOCK<br/>Threat: High"]
    G -->|No| I["‚úÖ Continue to Stage2_LGBM"]
    
    I --> J["ü§ñ Stage2_LGBM<br/>LightGBM ML Model"]
    J --> K{"üß† ML Prediction<br/>0=PASS, 1=FLAG, 2=BLOCK"}
    K -->|BLOCK| L["‚ùå BLOCK<br/>Band: BLOCK<br/>Action: BLOCK<br/>Threat: High"]
    K -->|FLAG| M["‚ö†Ô∏è ESCALATE<br/>Band: WARNING<br/>Action: FLAG_MEDIUM<br/>Threat: Medium"]
    K -->|PASS| N["‚úÖ Continue to Stage3_Detoxify"]
    
    N --> O["üß™ Stage3_Detoxify<br/>Toxicity Detection"]
    O --> P{"‚ò†Ô∏è Toxic Content<br/>Score > 0.5?"}
    P -->|Yes| Q["‚ùå BLOCK<br/>Band: BLOCK<br/>Action: BLOCK<br/>Threat: Medium/High"]
    P -->|No| R["‚úÖ Continue to Stage4_FinBert"]
    
    R --> S["üí∞ Stage4_FinBert<br/>Financial Sentiment Analysis"]
    S --> T["üìä Sentiment Analysis"]
    T --> U{"üìà Sentiment Score"}
    U -->|Negative High| V["‚ö†Ô∏è ESCALATE<br/>Band: WARNING<br/>Action: FLAG_MEDIUM<br/>Threat: Low"]
    U -->|Neutral/Positive| W["‚úÖ Continue to Stage5_LLM"]
    
    W --> X["üß† Stage5_LLM<br/>Chain-of-Thought Analysis"]
    X --> Y{"üì° Groq API Available?"}
    Y -->|No| Z["‚ö†Ô∏è Fallback Logic<br/>Check Previous Escalations"]
    Y -->|Yes| AA["üß† LLM Analysis"]
    
    Z --> BB{"üîç Previous Escalations?"}
    BB -->|Yes| CC["‚ùå BLOCK<br/>Band: WARNING<br/>Action: BLOCK<br/>Threat: Medium"]
    BB -->|No| DD["‚úÖ ACCEPT<br/>Band: SAFE<br/>Action: PASS<br/>Threat: Low"]
    
    AA --> EE{"üß† LLM Decision"}
    EE -->|FRAUD| FF["‚ùå BLOCK<br/>Band: BLOCK<br/>Action: BLOCK<br/>Threat: High"]
    EE -->|CLEAN| GG["‚úÖ ACCEPT<br/>Band: SAFE<br/>Action: PASS<br/>Threat: Low"]
    EE -->|UNCERTAIN| HH["‚ùå BLOCK<br/>Band: WARNING<br/>Action: BLOCK<br/>Threat: Medium"]
    
    H --> II["üíæ Enhanced Database<br/>PostgreSQL + Band/Action"]
    L --> II
    M --> II
    Q --> II
    V --> II
    CC --> II
    DD --> II
    FF --> II
    GG --> II
    HH --> II
    
    II --> JJ["üìä Enhanced Response<br/>ModerationResponse v2.1"]
    JJ --> KK["üîÑ Updated Frontend<br/>Band Badges + Confidence Bars"]
    
    LL["üìÅ data/external/words.json<br/>2736 Keywords"] --> F
    MM["üóÑÔ∏è PostgreSQL<br/>Enhanced Schema"] --> II
    
    style A fill:#e1f5fe
    style D fill:#f3e5f5
    style E fill:#fff3e0
    style S fill:#fff8e1
    style DD fill:#c8e6c9
    style GG fill:#c8e6c9
    style M fill:#fff3cd
    style V fill:#fff3cd
    style CC fill:#ffcdd2
    style FF fill:#ffcdd2
    style HH fill:#ffcdd2
    style II fill:#f3e5f5
    style KK fill:#e8f5e8
            </div>
        </div>

        <!-- Diagram 2: Enhanced Engine Pipeline -->
        <div class="diagram-container">
            <h2 class="diagram-title">üîß Advanced 5-Stage Moderation Pipeline<span class="new-feature">ENHANCED</span></h2>
            <div class="diagram-description">
                <strong>Detailed internal processing</strong> showing the new 5-stage pipeline with Stage1_RuleBased, Stage2_LGBM, Stage3_Detoxify, Stage4_FinBert, and Stage5_LLM. Includes sophisticated risk assessment and fallback logic.
            </div>
            <div class="mermaid">
graph TD
    A["üõ°Ô∏è GuardianModerationEngine.moderate_content()"] --> B["üìù Input: Content String"]
    
    B --> C["üî¥ Stage1_RuleBased"]
    C --> D["üìö Load Keywords from<br/>data/external/words.json<br/>(2736 keywords)"]
    D --> E["üîç Fuzzy Keyword Matching"]
    E --> F["üéØ Enhanced Regex Patterns<br/>URLs, Crypto Addresses, Threats"]
    F --> G{"‚ùì Rule Violations?"}
    
    G -->|Yes| H["‚ùå Return ModerationResult<br/>accepted=False<br/>stage='Stage1_RuleBased'<br/>threat_level='high'<br/>band='BLOCK'<br/>action='BLOCK'<br/>confidence=0.9"]
    
    G -->|No| I["üü° Stage2_LGBM"]
    I --> J["ü§ñ Initialize LightGBM Model<br/>lgbm_moderation.txt"]
    J --> K["üß† Feature Extraction"]
    K --> L["üìä ML Classification<br/>0=PASS, 1=FLAG, 2=BLOCK"]
    L --> M{"üéöÔ∏è Prediction Class"}
    
    M -->|2 (BLOCK)| N["‚ùå Return ModerationResult<br/>accepted=False<br/>stage='Stage2_LGBM'<br/>threat_level='high'<br/>band='BLOCK'<br/>action='BLOCK'<br/>confidence=score"]
    M -->|1 (FLAG)| O["‚ö†Ô∏è Return ModerationResult<br/>accepted=False<br/>stage='Stage2_LGBM'<br/>threat_level='medium'<br/>band='WARNING'<br/>action='FLAG_MEDIUM'<br/>confidence=score"]
    M -->|0 (PASS)| P["‚úÖ Continue to Stage3_Detoxify"]
    
    P --> Q["üü¢ Stage3_Detoxify"]
    Q --> R["ü§ñ Initialize Detoxify Model<br/>unitary/toxic-bert"]
    R --> S["üß† Toxicity Classification"]
    S --> T["üìä Get Toxicity Score (0-1)"]
    T --> U{"üéöÔ∏è Score > threshold<br/>(0.5)?"}
    
    U -->|Yes| V["‚ùå Return ModerationResult<br/>accepted=False<br/>stage='Stage3_Detoxify'<br/>threat_level='medium/high'<br/>band='BLOCK'<br/>action='BLOCK'<br/>confidence=score"]
    
    U -->|No| W["üü¢ Stage4_FinBert"]
    W --> X["üí∞ Initialize FinBERT Model<br/>ProsusAI/finbert"]
    X --> Y["üìà Financial Sentiment Analysis"]
    Y --> Z["üìä Get Sentiment + Confidence"]
    Z --> AA{"üìâ Negative Sentiment?"}
    
    AA -->|No| BB["üü¢ Non-Financial Content<br/>band='SAFE'<br/>action='PASS'<br/>threat_level='low'"]
    
    AA -->|Yes| CC["üéØ Sentiment Analysis"]
    CC --> DD["üìä Sentiment Classification"]
    
    DD --> EE["üü¢ SAFE Band<br/>Sentiment: Positive/Neutral<br/>action='PASS'<br/>threat_level='low'"]
    DD --> FF["üü° WARNING Band<br/>Sentiment: Negative Low<br/>action='FLAG_MEDIUM'<br/>threat_level='low'"]
    
    GG["üü¢ Stage5_LLM"]
    GG --> HH["üß† Initialize Groq LLM<br/>llama3-8b-8192"]
    HH --> II["üìù Chain-of-Thought Analysis"]
    II --> JJ["üìä LLM Decision<br/>FRAUD/CLEAN/UNCERTAIN"]
    JJ --> KK{"üéØ LLM Result"}
    
    KK -->|FRAUD| LL["‚ùå Return ModerationResult<br/>accepted=False<br/>stage='Stage5_LLM'<br/>threat_level='high'<br/>band='BLOCK'<br/>action='BLOCK'<br/>confidence=0.9"]
    KK -->|CLEAN| MM["‚úÖ Return ModerationResult<br/>accepted=True<br/>stage='Stage5_LLM'<br/>threat_level='low'<br/>band='SAFE'<br/>action='PASS'<br/>confidence=0.9"]
    KK -->|UNCERTAIN| NN["‚ùå Return ModerationResult<br/>accepted=False<br/>stage='Stage5_LLM'<br/>threat_level='medium'<br/>band='WARNING'<br/>action='BLOCK'<br/>confidence=0.5"]
    
    OO["‚öôÔ∏è Enhanced Configuration"] --> PP["üéöÔ∏è toxicity_threshold = 0.5<br/>üéöÔ∏è lgbm_model_path = lgbm_moderation.txt<br/>üéöÔ∏è groq_timeout = 30s<br/>üéØ 5-stage pipeline system"]
    PP --> U
    PP --> DD
    PP --> KK
    
    style C fill:#ffebee
    style I fill:#e8f5e8
    style Q fill:#fff8e1
    style W fill:#e1f5fe
    style GG fill:#f3e5f5
    style H fill:#ffcdd2
    style N fill:#ffcdd2
    style V fill:#ffcdd2
    style LL fill:#ffcdd2
    style NN fill:#ffcdd2
    style O fill:#fff3cd
    style FF fill:#fff3cd
    style BB fill:#c8e6c9
    style MM fill:#c8e6c9
            </div>
        </div>

        <!-- Diagram 3: Enhanced Sequence -->
        <div class="diagram-container">
            <h2 class="diagram-title">üîÑ Advanced 5-Stage Interaction Sequence<span class="new-feature">UPDATED</span></h2>
            <div class="diagram-description">
                <strong>Real-time communication flow</strong> with enhanced 5-stage pipeline, action determination, and visual feedback including confidence bars and band badges in the frontend.
            </div>
            <div class="mermaid">
sequenceDiagram
    participant User as üë§ User
    participant Frontend as üåê Frontend v2.1<br/>(Enhanced UI)
    participant API as ‚ö° FastAPI Server<br/>(main.py)
    participant Engine as üõ°Ô∏è ModerationEngine v2.1<br/>(moderation.py)
    participant DB as üóÑÔ∏è Enhanced Database<br/>(band + action columns)
    participant Keywords as üìÅ Keywords File<br/>(2736 words)
    participant LGBM as ü§ñ LightGBM Model<br/>(lgbm_moderation.txt)
    participant Detoxify as üß™ Detoxify AI<br/>(toxic-bert)
    participant FinBert as üí∞ FinBERT<br/>(finbert)
    participant LLM as üß† Groq LLM<br/>(llama3-8b)
    
    User->>Frontend: Enter content in enhanced form
    User->>Frontend: Click "üöÄ Submit for Moderation"
    
    Frontend->>Frontend: Enhanced validation & loading state
    Frontend->>API: POST /moderate<br/>{"content": "user text"}
    
    API->>Engine: moderate_content(content)
    
    Engine->>Keywords: Load enhanced keyword list
    Keywords-->>Engine: Return 2736 keywords
    
    Engine->>Engine: Stage1_RuleBased: Enhanced rule-based check
    
    alt Rule violation found
        Engine-->>API: ModerationResult(band="BLOCK", action="BLOCK")
    else No rule violation
        Engine->>LGBM: Stage2_LGBM: LightGBM classification
        LGBM-->>Engine: ML prediction (0/1/2)
        
        alt Prediction = 2 (BLOCK)
            Engine-->>API: ModerationResult(band="BLOCK", action="BLOCK")
        else Prediction = 1 (FLAG)
            Engine-->>API: ModerationResult(band="WARNING", action="FLAG_MEDIUM")
        else Prediction = 0 (PASS)
            Engine->>Detoxify: Stage3_Detoxify: Toxicity check
            Detoxify-->>Engine: Toxicity score
            
            alt High toxicity
                Engine-->>API: ModerationResult(band="BLOCK", action="BLOCK")
            else Low toxicity
                Engine->>FinBert: Stage4_FinBert: Sentiment analysis
                FinBert-->>Engine: Financial sentiment + confidence
                
                alt Negative sentiment
                    Engine-->>API: ModerationResult(band="WARNING", action="FLAG_MEDIUM")
                else Positive/Neutral sentiment
                    Engine->>LLM: Stage5_LLM: Chain-of-thought analysis
                    LLM-->>Engine: LLM decision (FRAUD/CLEAN/UNCERTAIN)
                    
                    alt LLM = FRAUD
                        Engine-->>API: ModerationResult(band="BLOCK", action="BLOCK")
                    else LLM = CLEAN
                        Engine-->>API: ModerationResult(band="SAFE", action="PASS")
                    else LLM = UNCERTAIN
                        Engine-->>API: ModerationResult(band="WARNING", action="BLOCK")
                    end
                end
            end
        end
    end
    
    API->>DB: Save enhanced Post with band/action
    DB-->>API: Return post ID
    
    API-->>Frontend: Enhanced ModerationResponse<br/>{accepted, reason, band, action, confidence, etc}
    
    Frontend->>Frontend: Display enhanced result UI
    Frontend->>Frontend: Show band badge with color coding
    Frontend->>Frontend: Display confidence bar visualization
    Frontend->>Frontend: Update action status with styling
    
    Frontend->>API: GET /posts (refresh enhanced table)
    API->>DB: Query posts with band/action data
    DB-->>API: Return enhanced posts array
    API-->>Frontend: Posts with band/action metadata
    Frontend->>Frontend: Update table with band badges & confidence
    
    Note over User,AI: Complete enhanced moderation cycle<br/>with 5-layer band classification
            </div>
        </div>

        <!-- Diagram 4: Enhanced Database Operations -->
        <div class="diagram-container">
            <h2 class="diagram-title">üíæ Enhanced Database Schema & Operations<span class="new-feature">EXTENDED</span></h2>
            <div class="diagram-description">
                <strong>Extended data persistence</strong> with new band and action columns, enhanced statistics with band breakdown, and comprehensive metadata tracking for the 5-stage classification system.
            </div>
            <div class="mermaid">
graph TD
    A["üöÄ FastAPI Application Startup"] --> B["üóÑÔ∏è Initialize PostgreSQL<br/>content_moderation"]
    
    B --> C["üìã Create Enhanced Post Table"]
    C --> D["üèóÔ∏è Enhanced Table: posts<br/>- id (Primary Key)<br/>- content (Text)<br/>- accepted (Boolean)<br/>- reason (Text)<br/>- threat_level (String)<br/>- confidence (String)<br/>üÜï band (String)<br/>üÜï action (String)<br/>- stage (String)<br/>- created_at (DateTime)"]
    
    E["üì§ Enhanced Moderation Request"] --> F["üõ°Ô∏è Process with 5-Stage Pipeline"]
    F --> G["üìä Get Enhanced ModerationResult"]
    G --> H["üíæ Create Enhanced Post Object"]
    
    H --> I["üîÑ Database Session"]
    I --> J["‚ûï Add Post with Band/Action"]
    J --> K["üíæ Commit Enhanced Transaction"]
    K --> L["üîÑ Refresh Post (get ID)"]
    L --> M["üîê Close Session"]
    
    M --> N["üìà Enhanced API Endpoints"]
    
    N --> O["üìö GET /posts<br/>Enhanced Post Retrieval"]
    N --> P["üìä GET /stats<br/>Band-Aware Statistics"] 
    N --> Q["üè† GET /<br/>Enhanced System Status"]
    N --> R["üè• GET /health<br/>Model Status Check"]
    
    O --> S["üîç Query Enhanced Posts<br/>WITH band/action data<br/>ORDER BY created_at DESC"]
    P --> T["üìà Calculate Enhanced Stats<br/>- Total posts<br/>- Accepted/Rejected counts<br/>- Acceptance rate<br/>- Breakdown by stage<br/>- Threat level distribution<br/>üÜï Band breakdown<br/>üÜï Action statistics"]
    
    S --> U["üìã Return Enhanced JSON<br/>Posts with band badges"]
    T --> V["üìä Return Comprehensive Stats<br/>Including band analytics"]
    
    W["üîß Enhanced Admin Endpoints"] --> X["üîÑ POST /admin/reload-keywords<br/>Refresh 2736 keywords"]
    W --> Y["‚öôÔ∏è POST /admin/update-thresholds<br/>Modify AI + Band thresholds"]
    
    Z["üéØ 5-Stage Pipeline Data"] --> AA["üìä Stage Classification<br/>Stage1_RuleBased: Keywords + Regex<br/>Stage2_LGBM: LightGBM ML<br/>Stage3_Detoxify: Toxicity<br/>Stage4_FinBert: Sentiment<br/>Stage5_LLM: Chain-of-Thought"]
    
    AA --> H
    
    style B fill:#e3f2fd
    style D fill:#f3e5f5
    style H fill:#fff3e0
    style I fill:#e8f5e8
    style N fill:#fff8e1
    style S fill:#f1f8e9
    style T fill:#fce4ec
    style AA fill:#e1f5fe
            </div>
        </div>

        <!-- Diagram 5: Advanced AI Models -->
        <div class="diagram-container">
            <h2 class="diagram-title">ü§ñ AI Models with 5-Stage Pipeline Processing<span class="new-feature">ADVANCED</span></h2>
            <div class="diagram-description">
                <strong>Sophisticated AI processing</strong> featuring the new 5-stage pipeline with Stage1_RuleBased, Stage2_LGBM, Stage3_Detoxify, Stage4_FinBert, and Stage5_LLM. Includes intelligent action determination and fallback logic.
            </div>
            <div class="mermaid">
graph TD
    A["üß† Enhanced AI Models Pipeline"] --> B["ü§ñ Model Initialization"]
    
    B --> C["üî¥ Stage1_RuleBased<br/>Keywords + Regex<br/>2736 Keywords"]
    B --> D["ü§ñ Stage2_LGBM<br/>LightGBM Model<br/>lgbm_moderation.txt"]
    B --> E["üß™ Stage3_Detoxify<br/>unitary/toxic-bert<br/>Toxicity Detection"]
    B --> F["üí∞ Stage4_FinBert<br/>ProsusAI/finbert<br/>Financial Sentiment"]
    B --> G["üß† Stage5_LLM<br/>Groq LLM<br/>Chain-of-Thought"]
    
    C --> H["üì• Load Keywords File"]
    H --> I["üîç Fuzzy Keyword Matching"]
    I --> J["‚úÖ Rule-Based Ready<br/>2736 Keywords Loaded"]
    
    D --> K["üì• Load LightGBM Model"]
    K --> L["üß† Feature Extraction"]
    L --> M["‚úÖ LGBM Ready<br/>3-Class Classification"]
    
    E --> N["üì• Load Transformer Model"]
    N --> O["‚öôÔ∏è Set Device to CPU"]
    O --> P["‚úÖ Detoxify Ready<br/>Threshold: 0.5"]
    
    F --> Q["üì• Load Financial Model"]
    Q --> R["‚öôÔ∏è Set Device to CPU"] 
    R --> S["‚úÖ FinBERT Ready<br/>Sentiment Analysis Active"]
    
    G --> T["üì• Initialize Groq Client"]
    T --> U["‚öôÔ∏è Set API Key & Timeout"]
    U --> V["‚úÖ LLM Ready<br/>Chain-of-Thought Active"]
    
    W["üìù Input Text"] --> X["üî¥ Stage1_RuleBased: Keyword Check"]
    
    X --> Y["üîç Pattern Matching"]
    Y --> Z{"üéØ Rule Violations?"}
    
    Z -->|Yes| AA["‚ùå BLOCK DETECTED<br/>band='BLOCK'<br/>action='BLOCK'<br/>threat_level='high'"]
    Z -->|No| BB["‚úÖ CONTINUE TO Stage2_LGBM"]
    
    BB --> CC["ü§ñ Stage2_LGBM: ML Classification"]
    CC --> DD["üß† Feature Extraction"]
    DD --> EE["üìä ML Prediction<br/>0=PASS, 1=FLAG, 2=BLOCK"]
    EE --> FF{"üéöÔ∏è Prediction Class"}
    
    FF -->|2 (BLOCK)| GG["‚ùå BLOCK DETECTED<br/>band='BLOCK'<br/>action='BLOCK'<br/>threat_level='high'"]
    FF -->|1 (FLAG)| HH["‚ö†Ô∏è FLAG DETECTED<br/>band='WARNING'<br/>action='FLAG_MEDIUM'<br/>threat_level='medium'"]
    FF -->|0 (PASS)| II["‚úÖ CONTINUE TO Stage3_Detoxify"]
    
    II --> JJ["üß™ Stage3_Detoxify: Toxicity Check"]
    JJ --> KK["üß† Toxicity Classification"]
    KK --> LL["üìä Get Toxicity Score (0-1)"]
    LL --> MM{"üéöÔ∏è Score > 0.5?"}
    
    MM -->|Yes| NN["‚ùå TOXIC DETECTED<br/>band='BLOCK'<br/>action='BLOCK'<br/>threat_level='medium/high'"]
    MM -->|No| OO["‚úÖ CONTINUE TO Stage4_FinBert"]
    
    OO --> PP["üí∞ Stage4_FinBert: Sentiment Analysis"]
    PP --> QQ["üìà Financial Sentiment Analysis"]
    QQ --> RR["üìä Get Sentiment + Confidence"]
    RR --> SS{"üìâ Negative Sentiment?"}
    
    SS -->|No| TT["üü¢ POSITIVE/NEUTRAL<br/>band='SAFE'<br/>action='PASS'<br/>threat_level='low'"]
    SS -->|Yes| UU["‚ö†Ô∏è NEGATIVE SENTIMENT<br/>band='WARNING'<br/>action='FLAG_MEDIUM'<br/>threat_level='low'"]
    
    VV["üß† Stage5_LLM: Chain-of-Thought"]
    VV --> WW["üìù Generate Prompt"]
    WW --> XX["üß† LLM Analysis"]
    XX --> YY["üìä Get Decision<br/>FRAUD/CLEAN/UNCERTAIN"]
    YY --> ZZ{"üéØ LLM Result"}
    
    ZZ -->|FRAUD| AAA["‚ùå FRAUD DETECTED<br/>band='BLOCK'<br/>action='BLOCK'<br/>threat_level='high'"]
    ZZ -->|CLEAN| BBB["‚úÖ CLEAN CONTENT<br/>band='SAFE'<br/>action='PASS'<br/>threat_level='low'"]
    ZZ -->|UNCERTAIN| CCC["‚ö†Ô∏è UNCERTAIN<br/>band='WARNING'<br/>action='BLOCK'<br/>threat_level='medium'"]
    
    DDD["‚ö†Ô∏è Enhanced Error Handling"] --> EEE["üîß Graceful Model Failures"]
    EEE --> FFF["üîÑ Smart Fallbacks<br/>- Log detailed warnings<br/>- Continue pipeline<br/>- Return safe defaults<br/>- Maintain 5-stage system"]
    
    GGG["üéõÔ∏è Advanced Configuration"] --> HHH["üéöÔ∏è Enhanced Thresholds<br/>- Toxicity: 0.5<br/>- LGBM: 3-class classification<br/>- Groq Timeout: 30s<br/>üéØ Stage Configuration<br/>- Stage1_RuleBased: Keywords + Regex<br/>- Stage2_LGBM: LightGBM ML<br/>- Stage3_Detoxify: Toxicity<br/>- Stage4_FinBert: Sentiment<br/>- Stage5_LLM: Chain-of-Thought"]
    
    HHH --> MM
    HHH --> ZZ
    
    style C fill:#ffebee
    style D fill:#e8f5e8
    style E fill:#fff8e1
    style F fill:#e1f5fe
    style G fill:#f3e5f5
    style J fill:#c8e6c9
    style M fill:#c8e6c9
    style P fill:#c8e6c9
    style S fill:#c8e6c9
    style V fill:#c8e6c9
    style AA fill:#ffcdd2
    style GG fill:#ffcdd2
    style NN fill:#ffcdd2
    style AAA fill:#ffcdd2
    style CCC fill:#ffcdd2
    style TT fill:#c8e6c9
    style BBB fill:#c8e6c9
    style HH fill:#fff3cd
    style UU fill:#fff3cd
    style EEE fill:#fff3e0
    style FFF fill:#fff3e0
            </div>
        </div>

        <!-- Diagram 6: Enhanced Architecture -->
        <div class="diagram-container">
            <h2 class="diagram-title">üèóÔ∏è Complete 5-Stage System Architecture<span class="new-feature">UPGRADED</span></h2>
            <div class="diagram-description">
                <strong>Comprehensive system architecture</strong> showcasing the enhanced layered design with the new 5-stage pipeline, upgraded UI components, and extended database schema.
            </div>
            <div class="mermaid">
graph TD
    A["üåê Frontend Layer<br/>Enhanced UI v2.1"] --> B["üì§ User Interface<br/>- Content Input Form<br/>- Real-time Results<br/>- Band Badges<br/>- Confidence Bars<br/>- Action Status"]
    
    B --> C["üöÄ API Gateway<br/>FastAPI Server"]
    C --> D["üõ°Ô∏è Moderation Engine<br/>5-Stage Pipeline"]
    
    D --> E["üìã Stage1_RuleBased<br/>Enhanced Rule-Based<br/>- 2736 keywords matching<br/>- Advanced regex patterns<br/>- Enhanced threat detection<br/>- Direct BLOCK classification"]
    D --> F["ü§ñ Stage2_LGBM<br/>LightGBM ML Model<br/>- Feature extraction<br/>- 3-class classification<br/>- Confidence scoring<br/>- ML-based decisions"]
    D --> G["üß™ Stage3_Detoxify<br/>Toxicity Detection<br/>- Toxicity classification<br/>- unitary/toxic-bert<br/>- Threshold: 0.5<br/>- BLOCK on detection"]
    D --> H["üí∞ Stage4_FinBert<br/>Financial Sentiment<br/>- Financial sentiment analysis<br/>- ProsusAI/finbert<br/>- Sentiment classification<br/>- Confidence-based decisions"]
    D --> I["üß† Stage5_LLM<br/>Chain-of-Thought<br/>- Groq LLM integration<br/>- llama3-8b-8192<br/>- Chain-of-thought reasoning<br/>- Fallback logic"]
    
    J["üóÑÔ∏è Data Layer<br/>PostgreSQL"] --> K["üìä Enhanced Database<br/>- Posts with band/action<br/>- Comprehensive metadata<br/>- Performance analytics<br/>- Audit trail"]
    
    L["üîß Configuration Layer"] --> M["‚öôÔ∏è System Config<br/>- Environment variables<br/>- Model thresholds<br/>- API keys<br/>- Timeout settings"]
    
    N["üìà Analytics Layer"] --> O["üìä Enhanced Statistics<br/>- Band breakdown<br/>- Action statistics<br/>- Stage performance<br/>- System health"]
    
    P["üõ°Ô∏è Security Layer"] --> Q["üîí Security Features<br/>- Input validation<br/>- SQL injection protection<br/>- CORS configuration<br/>- API key management"]
    
    R["üîÑ Fallback Layer"] --> S["‚ö†Ô∏è Error Handling<br/>- Model failure recovery<br/>- Graceful degradation<br/>- Fallback decisions<br/>- System continuity"]
    
    T["üìù Input Processing"] --> U["üîç Stage1_RuleBased Check"]
    U --> V{"‚ùì Rule Violations?"}
    V -->|Yes| W["‚ùå BLOCK Decision"]
    V -->|No| X["ü§ñ Stage2_LGBM Classification"]
    
    X --> Y{"üß† ML Prediction"}
    Y -->|BLOCK| Z["‚ùå BLOCK Decision"]
    Y -->|FLAG| AA["‚ö†Ô∏è ESCALATE Decision"]
    Y -->|PASS| BB["üß™ Stage3_Detoxify Check"]
    
    BB --> CC{"‚ò†Ô∏è Toxic Content?"}
    CC -->|Yes| DD["‚ùå BLOCK Decision"]
    CC -->|No| EE["üí∞ Stage4_FinBert Analysis"]
    
    EE --> FF{"üìà Sentiment Score"}
    FF -->|Negative| GG["‚ö†Ô∏è ESCALATE Decision"]
    FF -->|Positive/Neutral| HH["üß† Stage5_LLM Analysis"]
    
    HH --> II{"üì° LLM Available?"}
    II -->|No| JJ["‚ö†Ô∏è Fallback Logic"]
    II -->|Yes| KK["üß† LLM Decision"]
    
    KK --> LL{"üéØ LLM Result"}
    LL -->|FRAUD| MM["‚ùå BLOCK Decision"]
    LL -->|CLEAN| NN["‚úÖ ACCEPT Decision"]
    LL -->|UNCERTAIN| OO["‚ùå BLOCK Decision"]
    
    JJ --> PP{"üîç Previous Escalations?"}
    PP -->|Yes| QQ["‚ùå BLOCK Decision"]
    PP -->|No| RR["‚úÖ ACCEPT Decision"]
    
    W --> SS["üíæ Database Storage"]
    Z --> SS
    DD --> SS
    MM --> SS
    OO --> SS
    QQ --> SS
    AA --> SS
    GG --> SS
    NN --> SS
    RR --> SS
    
    SS --> TT["üìä Enhanced Response"]
    TT --> UU["üîÑ Frontend Update"]
    
    style A fill:#e1f5fe
    style D fill:#fff3e0
    style E fill:#ffebee
    style F fill:#e8f5e8
    style G fill:#fff8e1
    style H fill:#e1f5fe
    style I fill:#f3e5f5
    style J fill:#f3e5f5
    style L fill:#fff3e0
    style N fill:#fff8e1
    style P fill:#ffebee
    style R fill:#fff3e0
    style SS fill:#f3e5f5
    style UU fill:#e8f5e8
            </div>
        </div>

        <!-- Diagram 7: Complete Enhanced Data Flow -->
        <div class="diagram-container">
            <h2 class="diagram-title">üìä Complete Enhanced End-to-End Data Flow<span class="new-feature">COMPREHENSIVE</span></h2>
            <div class="diagram-description">
                <strong>Ultimate process visualization</strong> showing every step from user input to 5-stage classification, including the new pipeline system, confidence scoring, action determination, and enhanced visual feedback.
            </div>
            <div class="mermaid">
flowchart TD
    Start([üë§ User starts enhanced moderation]) --> Input["üìù Enter content in enhanced form<br/>(index.html v2.1)"]
    
    Input --> Validate{"üîç Enhanced Validation<br/>Content not empty?"}
    Validate -->|No| Error1["‚ùå Show enhanced error"]
    Validate -->|Yes| Submit["üì§ Submit enhanced POST /moderate"]
    
    Submit --> Server["‚ö° FastAPI v2.1 receives request<br/>(main.py)"]
    Server --> InitEngine["üõ°Ô∏è Initialize Enhanced Engine v2.1"]
    
    InitEngine --> LoadKeywords["üìö Load 2736 keywords from<br/>data/external/words.json"]
    LoadKeywords --> LoadModels["ü§ñ Load enhanced AI models<br/>LightGBM + Detoxify + FinBERT + LLM"]
    
    LoadModels --> Stage1["üìã STAGE 1: Stage1_RuleBased"]
    Stage1 --> CheckKeywords["üîç Enhanced keyword matching<br/>Fuzzy matching + case insensitive"]
    CheckKeywords --> CheckRegex["üéØ Advanced regex patterns<br/>URLs, crypto addresses, threats"]
    
    CheckRegex --> Rule1{"‚ùì Rule violations detected?"}
    Rule1 -->|Yes| Reject1["‚ùå IMMEDIATE BLOCK<br/>Band: BLOCK<br/>Action: BLOCK<br/>Threat: High<br/>Confidence: 0.9"]
    Rule1 -->|No| Stage2["ü§ñ STAGE 2: Stage2_LGBM"]
    
    Stage2 --> LGBM["üß† Process with LightGBM model<br/>lgbm_moderation.txt"]
    LGBM --> MLScore["üìä Get ML prediction (0/1/2)"]
    MLScore --> ML1{"üéöÔ∏è Prediction class?"}
    
    ML1 -->|2 (BLOCK)| Reject2["‚ùå LGBM BLOCK<br/>Band: BLOCK<br/>Action: BLOCK<br/>Threat: High<br/>Confidence: Score"]
    ML1 -->|1 (FLAG)| Flag1["‚ö†Ô∏è LGBM FLAG<br/>Band: WARNING<br/>Action: FLAG_MEDIUM<br/>Threat: Medium<br/>Confidence: Score"]
    ML1 -->|0 (PASS)| Stage3["üß™ STAGE 3: Stage3_Detoxify"]
    
    Stage3 --> Detoxify["üß† Process with enhanced toxic-bert"]
    Detoxify --> ToxicScore["üìä Get toxicity score (0-1)"]
    ToxicScore --> Toxic1{"üéöÔ∏è Score > 0.5 threshold?"}
    
    Toxic1 -->|Yes| Reject3["‚ùå TOXICITY BLOCK<br/>Band: BLOCK<br/>Action: BLOCK<br/>Threat: Medium/High<br/>Confidence: Score"]
    Toxic1 -->|No| Stage4["üí∞ STAGE 4: Stage4_FinBert"]
    
    Stage4 --> FinBERT["üìà Process with enhanced FinBERT"]
    FinBERT --> FinSentiment["üìä Get financial sentiment + confidence"]
    FinSentiment --> SentimentCheck{"üìâ Negative sentiment?"}
    
    SentimentCheck -->|No| Stage5["üß† STAGE 5: Stage5_LLM"]
    SentimentCheck -->|Yes| Flag2["‚ö†Ô∏è NEGATIVE SENTIMENT<br/>Band: WARNING<br/>Action: FLAG_MEDIUM<br/>Threat: Low<br/>Confidence: Score"]
    
    Stage5 --> LLM["üß† Process with Groq LLM<br/>llama3-8b-8192"]
    LLM --> LLMCheck{"üì° LLM API Available?"}
    LLMCheck -->|No| Fallback["‚ö†Ô∏è FALLBACK LOGIC<br/>Check previous escalations"]
    LLMCheck -->|Yes| LLMAnalysis["üìù Chain-of-thought analysis"]
    
    LLMAnalysis --> LLMResult["üìä Get LLM decision<br/>FRAUD/CLEAN/UNCERTAIN"]
    LLMResult --> LLM1{"üéØ LLM Result?"}
    
    LLM1 -->|FRAUD| Reject4["‚ùå LLM FRAUD BLOCK<br/>Band: BLOCK<br/>Action: BLOCK<br/>Threat: High<br/>Confidence: 0.9"]
    LLM1 -->|CLEAN| Accept1["‚úÖ LLM CLEAN<br/>Band: SAFE<br/>Action: PASS<br/>Threat: Low<br/>Confidence: 0.9"]
    LLM1 -->|UNCERTAIN| Reject5["‚ùå LLM UNCERTAIN BLOCK<br/>Band: WARNING<br/>Action: BLOCK<br/>Threat: Medium<br/>Confidence: 0.5"]
    
    Fallback --> FallbackCheck{"üîç Previous escalations?"}
    FallbackCheck -->|Yes| Reject6["‚ùå FALLBACK BLOCK<br/>Band: WARNING<br/>Action: BLOCK<br/>Threat: Medium<br/>Confidence: 0.7"]
    FallbackCheck -->|No| Accept2["‚úÖ FALLBACK ACCEPT<br/>Band: SAFE<br/>Action: PASS<br/>Threat: Low<br/>Confidence: 0.6"]
    
    Reject1 --> SaveDB["üíæ Save to enhanced database<br/>with band + action columns"]
    Reject2 --> SaveDB
    Reject3 --> SaveDB
    Reject4 --> SaveDB
    Reject5 --> SaveDB
    Reject6 --> SaveDB
    Flag1 --> SaveDB
    Flag2 --> SaveDB
    Accept1 --> SaveDB
    Accept2 --> SaveDB
    
    SaveDB --> CreatePost["üèóÔ∏è Create enhanced Post record<br/>with band/action metadata"]
    CreatePost --> GetID["üÜî Get assigned post ID"]
    GetID --> Response["üìä Create enhanced ModerationResponse<br/>JSON with band/action/confidence"]
    
    Response --> Frontend["üåê Send to enhanced frontend"]
    Frontend --> DisplayResult["üì∫ Display enhanced result<br/>Band badges + confidence bars"]
    DisplayResult --> UpdateTable["üîÑ Refresh enhanced posts table<br/>GET /posts with bands"]
    
    UpdateTable --> ShowStats["üìà Update enhanced statistics<br/>GET /stats with band analytics"]
    ShowStats --> VisualFeedback["üé® Show visual feedback<br/>Color-coded bands + actions"]
    VisualFeedback --> End([‚úÖ Enhanced process complete])
    
    Error1 --> End
    
    style Input fill:#e1f5fe
    style Stage1 fill:#ffebee
    style Stage2 fill:#e8f5e8
    style Stage3 fill:#fff8e1
    style Stage4 fill:#e1f5fe
    style Stage5 fill:#f3e5f5
    style Reject1 fill:#ffcdd2
    style Reject2 fill:#ffcdd2
    style Reject3 fill:#ffcdd2
    style Reject4 fill:#ffcdd2
    style Reject5 fill:#ffcdd2
    style Reject6 fill:#ffcdd2
    style Flag1 fill:#fff3cd
    style Flag2 fill:#fff3cd
    style Accept1 fill:#c8e6c9
    style Accept2 fill:#c8e6c9
    style SaveDB fill:#e3f2fd
    style DisplayResult fill:#f1f8e9
    style VisualFeedback fill:#e8f5e8
            </div>
        </div>
    </div>

    <button class="back-to-top" onclick="scrollToTop()">‚¨ÜÔ∏è</button>

    <script>
        // Initialize Mermaid with enhanced settings
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                diagramMarginX: 50,
                diagramMarginY: 10,
                actorMargin: 50,
                width: 150,
                height: 65,
                boxMargin: 10,
                boxTextMargin: 5,
                noteMargin: 10,
                messageMargin: 35
            }
        });

        // Enhanced back to top functionality
        window.addEventListener('scroll', function() {
            const backToTop = document.querySelector('.back-to-top');
            if (window.pageYOffset > 300) {
                backToTop.style.display = 'block';
                backToTop.style.opacity = '1';
            } else {
                backToTop.style.display = 'none';
                backToTop.style.opacity = '0';
            }
        });

        function scrollToTop() {
            window.scrollTo({ 
                top: 0, 
                behavior: 'smooth' 
            });
        }

        // Enhanced console logging
        console.log('üéâ Enhanced Content Moderation Engine v2.0 - All Diagrams Loaded!');
        console.log('üìä 7 enhanced diagrams with 5-layer band system');
        console.log('üéØ Features: Band classification, action mapping, confidence visualization');
        console.log('üîÑ Scroll to view all enhanced diagrams');
        
        // Add smooth scroll behavior for better UX
        document.documentElement.style.scrollBehavior = 'smooth';
    </script>
</body>
</html> 